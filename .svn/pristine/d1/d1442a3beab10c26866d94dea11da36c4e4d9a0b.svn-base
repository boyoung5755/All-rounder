<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.groupware.attendance.dao.AttendanceDAO">

	<resultMap type="AttendanceVO" id="aMap" autoMapping="true">
		<id property="attDate" column="ATT_DATE"/>
		<id property="empCd" column="EMP_CD"/>
		<collection property="alList" ofType="AttendanceLogVO" autoMapping="true"/>
	</resultMap>

	<select id="attendanceList" resultType="EmployeeVO">
		SELECT emp_cd
		FROM employee
	</select>
	
	<insert id="attendanceInsert" parameterType="AttendanceLogVO" useGeneratedKeys="true">
		<selectKey keyColumn="ATT_LOG_TIME,ATT_DATE" keyProperty="attLogTime,attDate" resultType="hashmap" order="BEFORE">
			SELECT TO_CHAR(SYSDATE,'HH24MISS') ATT_LOG_TIME, TO_CHAR(SYSDATE,'YYYYMMDD') ATT_DATE FROM DUAL
		</selectKey>
		INSERT INTO ATTENDANCE_LOG (
		    ATT_LOG,
		    ATT_LOG_TIME,
		    ATT_DATE,
		    EMP_CD
		) VALUES (
		    #{attLog},
		    #{attLogTime},
		    #{attDate},
		    #{empCd}
		)
	</insert>
	
	<select id="selectAttendance" resultType="AttendanceVO" parameterType="AttendanceVO">
		SELECT ATT_DATE
			, EMP_CD
			, START_TIME
			, END_TIME
		FROM
			(SELECT ATT_DATE
			, EMP_CD
			, START_TIME
			, END_TIME
			FROM ATTENDANCE
			WHERE EMP_CD=#{empCd}
			ORDER BY ATT_DATE DESC)
		WHERE ROWNUM=1
	</select>
	
	<select id="attendanceLogList" resultType="AttendanceLogVO" parameterType="AttendanceLogVO">
		SELECT ATT_LOG, ATT_LOG_TIME, ATT_DATE, EMP_CD, SUBSTR(ATT_LOG_TIME,0,2)||':'||SUBSTR(ATT_LOG_TIME,3,2) lTime
		FROM ATTENDANCE_LOG
		WHERE EMP_CD=#{empCd}
		<![CDATA[
			AND ATT_DATE+1||'06'>TO_CHAR(SYSDATE,'YYYYMMDDHH24')
		]]>
		ORDER BY ATT_LOG_TIME ASC
	</select>
	
	<update id="commute" parameterType="AttendanceVO">
		MERGE INTO ATTENDANCE
		USING DUAL
		<![CDATA[
		ON (ATT_DATE+1||'06'>TO_CHAR(SYSDATE,'YYYYMMDDHH24') AND EMP_CD=#{empCd})
		]]>
		WHEN MATCHED THEN 
		    UPDATE SET END_TIME=TO_CHAR(SYSDATE,'HH24MISS')
		    WHERE ATT_DATE=TO_CHAR(SYSDATE,'YYYYMMDD')
		WHEN NOT MATCHED THEN
		    INSERT (ATT_DATE,EMP_CD,START_TIME)
		    VALUES(TO_CHAR(SYSDATE,'YYYYMMDD'),#{empCd},TO_CHAR(SYSDATE,'HH24MISS'))
	</update>
</mapper>