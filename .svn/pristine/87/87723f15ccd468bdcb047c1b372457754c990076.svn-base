<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="kr.or.ddit.admin.adproject.dao.AdminProjectDAO">
	
	<resultMap type="ProjectVO" id="projMap" autoMapping="true">
		<id property="proSn" column="PRO_SN"/>
		<collection property="pjobList"  ofType="PjobVO" autoMapping="true">
			<id property="jobSn" column="JOB_SN"/> 
			<id property="proSn" column="PRO_SN"/>   
		<collection property="chargerList" ofType="ChargerVO" autoMapping="true">
			<id property="empCd" column="EMP_CD" /> 
			<association property="emp" javaType="EmployeeVO" autoMapping="true">
			</association>
		</collection>
		</collection>
		<collection property="pmemberList" ofType="PmemberVO" autoMapping="true">
			<id property="empCd" column="EMP_CD"/> 
		</collection>
		  
	</resultMap>	
	
<!-- 	페이징을 위한 총 개수 카운 -->
	<select id="selectTotalRecord" parameterType="PaginationInfo" resultType="int">
		SELECT COUNT(*)
		FROM PROJECT
	</select>
	
	
	
	<select id="selectAdminProjectList" parameterType="PaginationInfo" resultMap="projMap">
		SELECT BOARDVIEW1.*
			FROM ( SELECT A.*, ROWNUM RNUM
				FROM(
					SELECT 
	    P.PRO_SN,
	    P.PRO_NM, 
	    TO_CHAR(TO_DATE(P.PRO_BDATE, 'YYYYMMDD'), 'YY.MM.DD') AS PRO_BDATE,
	    TO_CHAR(TO_DATE(P.PRO_EDATE, 'YYYYMMDD'), 'YY.MM.DD') AS PRO_EDATE, 
	    P.PRO_STTUS,
	    P.PRO_PROGRS,
	    E.EMP_NAME AS EMP_CD,
	    PE.PRO_LEADER, 
	    (SELECT COUNT(*) - COUNT(JOBU_SN) FROM PJOB WHERE PRO_SN = P.PRO_SN) AS UPPER_JOBCOUNT,
	    (SELECT COUNT(JOBU_SN) FROM PJOB WHERE PRO_SN = P.PRO_SN AND JOBU_SN IS NOT NULL) AS LOWER_JOBCOUNT,
	    (SELECT COUNT(EMP_CD) FROM PMEMBER  WHERE PRO_SN = P.PRO_SN) AS PMEM_COUNT
	FROM
	    PROJECT P 
	LEFT OUTER JOIN
	    PMEMBER PE ON P.PRO_SN = PE.PRO_SN
	LEFT OUTER JOIN
	    EMPLOYEE E ON PE.EMP_CD = E.EMP_CD
	WHERE
	    PE.PRO_LEADER = 'Y'
		        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(simpleCondition.searchWord) and simpleCondition.searchType eq 'title'">
					AND	INSTR(PRO_NM, #{simpleCondition.searchWord}) > 0
				</if>	 
		        ORDER BY PRO_BDATE DESC 
		    ) A)  BOARDVIEW1
		<![CDATA[ 
		WHERE RNUM >= #{startRow} AND RNUM <= #{endRow}
		]]> 
	
	</select>
	
	<select id="upperCountJop" resultType="String" parameterType="ProjectVO">
	SELECT 
    	COUNT(*)-count(JOBU_SN)
	FROM 
   	 PJOB
	WHERE
    	PRO_SN = #{proSn} 
	
	</select>
	
	
	<select id="lowCountJob" resultType="String" parameterType="ProjectVO">
   	SELECT 
            COUNT(JOBU_SN)
            	FROM PJOB
            WHERE
            	PRO_SN= #{proSn}
            AND JOBU_SN IS NOT NULL 
	</select>
	
	
	
	
	
	
	
	
	
	
	
</mapper>