package kr.or.ddit.groupware.board.freeboard.service;

import java.util.List;

import javax.inject.Inject;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import kr.or.ddit.groupware.board.freeboard.dao.FreeBoardDAO;
import kr.or.ddit.groupware.board.notice.service.NoticeBoardServiceImpl;
import kr.or.ddit.vo.PaginationInfo;
import kr.or.ddit.vo.groupware.AnswerVO;
import kr.or.ddit.vo.groupware.BoardVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
public class FreeBoardServiceImpl implements FreeBoardService {
	
	@Inject
	private FreeBoardDAO freeDAO;

	@Override
	public List<BoardVO> selectFreeBoardList(PaginationInfo<BoardVO> paging) {
		log.info("$$$$ {}", paging);
		int totalRecord = freeDAO.selectTotalFree(paging);
		log.info("#### {}", totalRecord);
		paging.setTotalRecord(totalRecord);
		List<BoardVO> dataList = freeDAO.selectFreeBoardList(paging);
		log.info("*** {}", dataList);
		return dataList;
	}

	@Override
	public BoardVO selectFreeBoard(int bbsNo) {
		log.info("%%%%%%%%%%%%%% {}",bbsNo);
		return freeDAO.selectFreeBoard(bbsNo);
	}

	@Override
	public int answerInsert(AnswerVO answerVO) {
		String bbsNo = freeDAO.answerMax(answerVO.getBbsNo());
		answerVO.setAnswerCode(bbsNo);
		log.info("★★★ {}",answerVO);
		return freeDAO.answerInsert(answerVO);
	}

	@Override
	public int replyInsert(AnswerVO answerVO) {
		String replyMax = freeDAO.replyMax(answerVO.getAnswerUpcode());
		log.info("%%%%%%%%%%%%%%%{}",replyMax);
		
		String setReply = null;
		
		int aCount = replyMax.length() - replyMax.replace("_", "").length();
		log.info("))))))) {}",aCount);
		if(aCount == 1) {
			setReply = replyMax + "_1";
		}else {
			setReply = replyMax;
		}		
		answerVO.setAnswerCode(setReply);
		return freeDAO.replyInsert(answerVO);
	}

	@Override
	@Transactional
	public void answerDelete(AnswerVO answerVO) {
		log.info("%%%%%%%%%%%%% {}", answerVO);
		String replyCode = answerVO.getAnswerCode();
		int cnt = freeDAO.replyAllDelete(replyCode);
		if(cnt > 0) {
			freeDAO.answerAllDelete(answerVO);			
		}
	}

	@Override
	public int answerUpdate(AnswerVO answerVO) {
		log.info("######Update {}",answerVO);
		return freeDAO.answerUpdate(answerVO);
	}

}
