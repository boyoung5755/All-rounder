package kr.or.ddit.messenger.controller;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.inject.Inject;

import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import kr.or.ddit.messenger.service.MessengerService;
import kr.or.ddit.vo.ChatParticipantVO;
import lombok.extern.slf4j.Slf4j;

/**
 * @author 작성자명
 * @since 2023. 11. 6.
 * @version 1.0
 * @see javax.servlet.http.HttpServlet
 * 
 *      <pre>
 * [[개정이력(Modification Information)]]
 * 수정일       		수정자        수정내용
 * --------     --------    ----------------------
 * 2023. 11. 6.      박민주       최초작성
 * 2023. 11. 18.     박민주	    채팅방 CRUD 메소드 추가
 * 2023. 11. 19.     박민주		웹소켓을 통한 채팅 기능 메소드 추가
 * Copyright (c) 2023 by DDIT All right reserved
 *      </pre>
 */
@Controller
@RequestMapping("/messenger")
@Slf4j
public class MessengerController {

	@Inject
	private MessengerService service;

	@GetMapping
	public String chatForm(Model model) {
		List<ChatParticipantVO> chatList = service.retrieveChatRoomList();
		model.addAttribute("chatList", chatList);
		return "messenger/chatList";
	}

	@PostMapping
	@ResponseBody
	public Map<String, String> doPost(@RequestBody List<ChatParticipantVO> chatParticipantList,
			Authentication authentication) {
		log.info("controller에서 chatParticipantList 시큐리티 정보 주입 전 ====> " + chatParticipantList);
		String userEmpCd = authentication.getName();
		ChatParticipantVO userChatParticipantVO = new ChatParticipantVO(userEmpCd);
		chatParticipantList.add(userChatParticipantVO);
		log.info("controller에서 chatParticipantList 시큐리티 정보 주입 후 ====> " + chatParticipantList);
		service.createChatRoom(chatParticipantList);
		Map<String, String> resultMap = new HashMap<>();
		resultMap.put("success", "성공");
		return resultMap;
	}

	@DeleteMapping("{chatRoomCd}")
	@ResponseBody
	public Map<String, String> doDelete(@PathVariable("chatRoomCd") String chatRoomcd, Authentication authentication) {
		ChatParticipantVO chatParticipantVO = new ChatParticipantVO(chatRoomcd);
		chatParticipantVO.setChatRoomCd(chatRoomcd);
		chatParticipantVO.setChatEmpCd(authentication.getName());
		int result = service.removeChatRoom(chatParticipantVO);
		Map<String, String> resultMap = new HashMap<>();
		if (result > 0) {
			resultMap.put("result", "success");
		} else {
			resultMap.put("result", "fail");
		}
		return resultMap;
	}

	@PutMapping("{chatRoomCd}")
	@ResponseBody
	public Map<String, String> doPUT(@PathVariable("chatRoomCd") String chatRoomcd, @RequestBody String chatRoomNm,
			Authentication authentication) {
		ChatParticipantVO chatParticipantVO = new ChatParticipantVO(chatRoomcd);
		chatParticipantVO.setChatRoomCd(chatRoomcd);
		chatParticipantVO.setChatRoomNm(chatRoomNm);
		chatParticipantVO.setChatEmpCd(authentication.getName());

		int result = service.modifyChatRoom(chatParticipantVO);
		log.info("chatParticipantVO ==> " + chatParticipantVO);
		Map<String, String> resultMap = new HashMap<>();
		if (result > 0) {
			resultMap.put("result", "success");
		} else {
			resultMap.put("result", "fail");
		}
		return resultMap;
	}
}
