package kr.or.ddit.groupware.mailing.service;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;

import javax.inject.Inject;

import org.springframework.http.HttpStatus;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import jakarta.activation.DataHandler;
import jakarta.activation.DataSource;
import jakarta.mail.Message;
import jakarta.mail.MessagingException;
import jakarta.mail.Session;
import jakarta.mail.Transport;
import jakarta.mail.internet.InternetAddress;
import jakarta.mail.internet.MimeBodyPart;
import jakarta.mail.internet.MimeMessage;
import jakarta.mail.internet.MimeMultipart;
import jakarta.mail.util.ByteArrayDataSource;
import kr.or.ddit.common.enumpkg.ServiceResult;
import kr.or.ddit.common.exception.BoardNotFoundException;
import kr.or.ddit.groupware.mailing.dao.MailDAO;
import kr.or.ddit.login.dao.LoginDAO;
import kr.or.ddit.vo.PaginationInfo;
import kr.or.ddit.vo.groupware.EmployeeVO;
import kr.or.ddit.vo.groupware.MailAttachVO;
import kr.or.ddit.vo.groupware.MailReceptionVO;
import kr.or.ddit.vo.groupware.MailVO;
import lombok.extern.slf4j.Slf4j;

/**
 * @author 작성자명
 * @since 2023. 11. 7.
 * @version 1.0
 * @see javax.servlet.http.HttpServlet
 * 
 *      <pre>
 * [[개정이력(Modification Information)]]
 * 수정일        수정자               수정내용
 * --------     --------    ----------------------
 * 2023. 11. 7.      박민주       최초작성
 * 2023. 11. 12.     박민주		SMTP, IMAP을 사용하여 전송, 메일 불러오기 확인
 * 2023. 11. 13.     박민주		어플리케이션 내에서 메일 발송 기능 구현 완료 (파일첨부 기능 빠뜨림)
 * 2023. 11. 14.     박민주		+ 파일 첨부 기능 추가
 * 2023. 11. 14.     박민주       메일 불러오기 구현 중
 * 2023. 12. 02.     박민주       임시메일함, 휴지통, 중요메일함 목록 조회 추가
 * Copyright (c) 2023 by DDIT All right reserved
 *      </pre>
 */
@Slf4j
@Service
public class MailingServiceImpl implements MailingService {

	@Inject
	private MailDAO dao;

	@Inject
	private LoginDAO loginDao;

	@Override
	public ServiceResult mailSend(MailVO mailVO) {
		log.info("mailSend->mailVO.getMailCn() : " + mailVO.getMailCn().substring(1));
		String[] mailReceivers = mailVO.getMailReceivers(); 
		
		List<MailReceptionVO> mailReceiverList = new ArrayList<MailReceptionVO>();
		
		for(String mailReceiver : mailReceivers) {
			MailReceptionVO vo = new MailReceptionVO(mailReceiver);//E220101001, E220101002
			mailReceiverList.add(vo);
			log.info("MailReceptionVO ===> " + vo);
		}
		mailVO.setMailReceiverList(mailReceiverList);
		List<MailAttachVO> attachments = new ArrayList<MailAttachVO>();
		
		MultipartFile[] files = mailVO.getFiles();
		
		for(MultipartFile multipartFile : files) {
			MailAttachVO mailAttachVO = new MailAttachVO(multipartFile);
			
			attachments.add(mailAttachVO);
		}
		
		mailVO.setAttachments(attachments);
		EmployeeVO employeeVO = new EmployeeVO();

		/* 발신자 정보 (security) */
		String senderCd = SecurityContextHolder.getContext().getAuthentication().getName(); // 사원번호
		log.info("mailSend->senderCd : " + senderCd);
		employeeVO.setEmpCd(senderCd);
		EmployeeVO senderVO = loginDao.selectEmpForAuth(employeeVO);
		
		log.info("mailSend->senderVO : " + senderVO);
		//bagminju046@gmail.com
		String senderSecEmail = senderVO.getEmpEmailSecond(); // SMTP를 통한 메일 발송을 위해, 지정해둔 실제 second 메일 주소로 가져오기 !

		try {
			Session session = SMTPService.getMailSession();
			/* 메세지 생성 및 설정 */
			MimeMessage msg = new MimeMessage(session);
			InternetAddress addressFrom = new InternetAddress(senderSecEmail);
			msg.setFrom(addressFrom); // 보내는 사람 설정 (= security 에 인증된 사원의 second mail 주소)
			for (MailReceptionVO receiverVO : mailVO.getMailReceiverList()) { // 받는 사람 설정
				EmployeeVO tempEmployeeVO = new EmployeeVO();
				//mailReceivers=[E220101001, E220101002]
				tempEmployeeVO.setEmpCd(receiverVO.getMrReceiver());
				String receptionSecondMail = loginDao.selectEmpForAuth(tempEmployeeVO).getEmpEmailSecond();
				msg.addRecipient(Message.RecipientType.TO, new InternetAddress(receptionSecondMail));
			}
			msg.setSubject(mailVO.getMailSj(), "UTF-8"); // 제목
			msg.setText(mailVO.getMailCn().substring(1), "UTF-8"); // 내용
			msg.setSentDate(new Date()); // 날짜

			MimeMultipart mParts = new MimeMultipart();
			/* 첨부파일 처리 */
			for (MailAttachVO attachVO : mailVO.getAttachments()) {
				MimeBodyPart mFilePart = new MimeBodyPart();

				DataSource source = new ByteArrayDataSource(attachVO.getMailFile().getBytes(),
						attachVO.getMailFile().getContentType());
				System.out.println("파일 이름: " + attachVO.getMailFile().getOriginalFilename());

				// 데이터 핸들러를 사용하여 첨부 파일을 추가
				mFilePart.setDataHandler(new DataHandler(source));
				mFilePart.setFileName(attachVO.getMailFile().getOriginalFilename());

				// MimeMultipart에 첨부 파일 추가
				mParts.addBodyPart(mFilePart);
			}
			msg.setContent(mParts);
			Transport.send(msg);
			return ServiceResult.OK;
		} catch (MessagingException | IOException e) {
			e.printStackTrace();
			System.out.println(e.getMessage());
			return ServiceResult.FAIL;
		}
	}

	@Transactional
	@Override
	public void createMail(MailVO mailVO) {
		String senderCd = SecurityContextHolder.getContext().getAuthentication().getName(); // 사원번호
		mailVO.setMailSender(senderCd);
		dao.insertMailTb(mailVO);

		List<MailReceptionVO> mailReceptList = mailVO.getMailReceiverList();
		for (MailReceptionVO receptionVO : mailReceptList) {
			System.out.println("createMail->receptionVO : " + receptionVO);
			dao.insertMailReception(receptionVO);
		}

		//mailAttach 테이블에 insert
		List<MailAttachVO> mailAttachList = mailVO.getAttachments();
		for (MailAttachVO mailAttachVO : mailAttachList) {
			System.out.println("createMail->mailAttachVO : " + mailAttachVO);
			dao.insertMailAttach(mailAttachVO);
		}
	}
	

	//=============================수신메일 목록 조회=============================
	@Override
	public List<MailVO> retrieveRecptionMailList(PaginationInfo<MailVO> paging) {
		int totalRecord = dao.selectReceivedTotalRecord(paging);
		paging.setTotalRecord(totalRecord);
		List<MailVO> dataList = dao.selectReceptionMail(paging);
		paging.setDataList(dataList);
		return dataList;
	}

	//=============================발신 메일 목록 조회=============================
	@Override
	public List<MailVO> retrieveSentMailList(PaginationInfo<MailVO> paging) {
		int totalRecord = dao.selectSentTotalRecord(paging);
		paging.setTotalRecord(totalRecord);

		List<MailVO> dataList = dao.selectSentMailList(paging);
		paging.setDataList(dataList);

		return dataList;
	}
	
	//=============================중요 메일 목록 조회=============================
	@Override
	public List<MailVO> retrieveImpotantMailList(PaginationInfo<MailVO> paging) {
		int totalRecord = dao.selectImportantTotalRecord(paging);
		paging.setTotalRecord(totalRecord);
		
		List<MailVO> dataList = dao.selectImportantMailList(paging);
		paging.setDataList(dataList);
		
		return dataList;
	}
	
	//=============================휴지통 목록 조회=============================
	@Override
	public List<MailVO> trashMailList(PaginationInfo<MailVO> paging) {
		int totalRecord = dao.selectSentTotalRecord(paging);
		// TODO Auto-generated method stub
		return null;
	}
	

	@Override
	public MailVO getMAil() {
		return null;
	}

	@Override
	public MailVO retrieveMailDetail(String mailCd) {
		MailVO mail = dao.selectMailDetail(mailCd);
		if(mail==null) // 조회한 글이 없을경우
			throw new BoardNotFoundException(HttpStatus.NOT_FOUND, String.format("%d 해당 메일이 없음", mailCd));
		return mail;
	}

	@Override
	public int toggleImportant(String mailCd, String mailType) {
		int updateResult = 0;
		
		HashMap<String, String> paramMap = new HashMap<>();
		String loginUser = SecurityContextHolder.getContext().getAuthentication().getName(); // 사원번호
		
		log.info("mailType===============> "+ mailType);
		
		if("R".equals(mailType)) { //받은메일함
			log.info("받은메일함!!");
			paramMap.put("mrReceiver", loginUser);
			paramMap.put("mailCd", mailCd);
			
			MailReceptionVO receptionMailVO = dao.simpleSelectReceptionMail(paramMap);
			log.info("receptionMailVO=====>"  + receptionMailVO);
			if("N".equals(receptionMailVO.getMrImpoYn())){
				paramMap.put("mrImpoYn", "Y");
			}else {
				paramMap.put("mrImpoYn", "N");
			}
			updateResult = dao.updateReceivedMailImportant(paramMap);
		}else if("S".equals(mailType)) { //보낸메일함
			MailVO mailVO = dao.simpleSelectSentMail(mailCd);
			if("N".equals(mailVO.getMrImpoYn())){
				mailVO.setMrImpoYn("Y");
			}else {
				mailVO.setMrImpoYn("N");
			}
			updateResult = dao.updateSendMailImportant(mailVO);
		}
		return updateResult;
	}

	@Override
	public MailAttachVO retrieveMailAttach(String attNo) {
		MailAttachVO atch = dao.selectMailAttach(attNo);
		if (atch == null) {
			throw new BoardNotFoundException(HttpStatus.NOT_FOUND, String.format("%d 해당 파일이 없음.", attNo));
		}
		return atch;
	}

	
}