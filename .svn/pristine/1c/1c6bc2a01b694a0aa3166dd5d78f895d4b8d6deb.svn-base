/**
 * 
 */

const columnDefs = [
	{
		field: 'columnID',
		headerName: 'columnID',
		editable: true,
		cellEditor : 'agSelectCellEditor',
		cellEditorParams :{
            return : ['Option 1', 'Option 2', 'Option 3']
	  }
	},
	{checkboxSelection : true, headerCheckboxSelection: true},
	{ field: "vhcleCd", headerName: "차량 코드",sortable: true },
	{ field: "vhcleNo", headerName: "차량 번호" ,editable: true},
	{ field: "vhcleModel", headerName: "차량 모델", editable: true },
	{ field: "vhcleFlag", headerName: "차량 상태", editable: true,sortable: true},
	{ field: "vhcleCapacity", headerName: "수용인원(명)", editable: true},
	{ field: "vhcleRegistDate", headerName: "등록일자" ,sortable: true }
	// { field: "vhcleImgUrl", headerName:"모델"},
];

// 데이터 정의
const rowData = []; //초기값

// 설정 옵션: 중요, 위에 정의한 것들이 여기서 통합됨에 주목
const gridOptions = {
	columnDefs: columnDefs,
	rowSelection : 'multiple',
	rowData: rowData,
	defaultColDef: {
		flex: 1,       // 자동으로 같은 사이즈롱
		filter: true,
		resizable: true,
		minWidth: 100,
		headerClass: "centered"
	},
	pagination: true, //페이지설정
	paginationAutoPageSize: true,
	paginationPageSize: 5,
	localText:{noRowsToShow: '조회 결과가 없습니다.'}, //데이터가 없는 경우 보여 주는 사용자 메시지
	suppressMovableColumns:"true",//헤더고정
	onCellEditingStarted: event => {
		console.log(event);
		console.log("편집시작!");
	},
	onCellEditingStopped: event => {
		if(event.newValue !== event.oldValue){ //새로운 데이터 입력시 update 함수 실행
			updateData(event);
		}
	}
};

columnDefs.cellEditor = 'select';
columnDefs.cellEditorParams = {
    values: ['English', 'Spanish']
}

//차량 목록에서 한 셀의 editing 이 끝났을 때 실행하는 함수
const updateData = (event) => {
	
	var vehicleVO = event.data;
	delete vehicleVO['vhcleImage'];
	console.log("삭제 후 ---> ", vehicleVO);
	var xhr = new XMLHttpRequest();
	var vhcleCd = event.data.vhcleCd;
	xhr.open('PUT', `/adVehicle/${vhcleCd}`, true);
	xhr.setRequestHeader(CSRFHEADERNAME, CSRFTOKEN);
	xhr.setRequestHeader('content-type', 'application/json');
	xhr.onreadystatechange = function(){
		if (xhr.readyState == 4 && xhr.status == 200 ){
			console.log("수정 성공?");
		}
	}
	xhr.send(JSON.stringify(vehicleVO));
};

const getData = () => {
	var xhr = new XMLHttpRequest(); //비동기 통신을 담당하는 자바스크립트 객체
	xhr.open("GET", "/adVehicle", true); //요청 초기화
	xhr.onreadystatechange = function () {
		if (xhr.readyState == 4 && xhr.status == 200) { //수신완료&&통신성공
			let result = JSON.parse(xhr.responseText);
			for(var i = 0; i < result.length; i++) {
				var vhcleFlag = result[i].vhcleFlag;
				var vhcleFlagText = null;
				switch(vhcleFlag) {
					case "0":
						vhcleFlagText = "사용가능"
						break;
					case "1":
						vhcleFlagText = "사용중"
						break;
					case "2":
						vhcleFlagText = "예약중"
						break;
					default : 
						vhcleFlagText = "사용중지"
				}
				result[i].vhcleFlag = vhcleFlagText;
			}
			gridOptions.api.setRowData(result);
		}
	};
	xhr.send();
}

/*
function fSerialize(myForm){
	console.log("form ==> ", myForm);

	let sendData = [];
	let elems = myForm.elements;
	for(var elem of elems){
		console.log("element ==> ", elem.value);
		sendData[elem.name] = elem.value;
	}
	console.log("sendData ==> ", sendData);
}
*/

//차량 ag-grid 에서 삭제 버튼 클릭시
function fn_vhcleDelBtn(){
	var selectedData = gridOptions.api.getSelectedRows();
	
	if(selectedData.length==0){
		console.log("no data");
		Swal.fire("선택된 데이터가 없습니다.",'','error');
	}else if(selectedData.length==1){
		var selectedVhcleCd = selectedData[0]['vhcleCd'];
		console.log(selectedVhcleCd)
		var xhr = new XMLHttpRequest();
		xhr.open('DELETE', `/vehicle/${selectedVhcleCd}`, true);
		xhr.setRequestHeader(CSRFHEADERNAME, CSRFTOKEN);
		xhr.onreadystatechange = function(){
			if(xhr.readyState==4 && xhr.status==200){
				console.log("성공 ! ==> ", xhr.responseText);
				if(xhr.responseText=='OK'){
					Swal.fire('삭제되었습니다.', '','success').then((result)=>{
						location.reload();
					})
				}else{
					Swal.fire('삭제 실패하였습니다.', '','error').then((result)=>{
						location.reload();
					})
				}
				
			}
		}
		xhr.send();	
	}else{
		for(var i=0; i<selectedData.length; i++){
			var selectedVhcleCd = selectedData[i]['vhcleCd'];
			var xhr = new XMLHttpRequest();
			console.log(selectedVhcleCd);
			xhr.open('DELETE', `/adVehicle/${selectedVhcleCd}`, true);
			xhr.setRequestHeader(CSRFHEADERNAME, CSRFTOKEN);
			xhr.onreadystatechange = function(){
				if(xhr.readyState==4 && xhr.status==200){
					console.log(i +"번째 데이터 삭제 성공 ! ==> ", xhr.responseText);
					Swal.fire(`삭제되었습니다.`, '','success').then((result)=>{
						location.reload();
					})
				}
			}
			xhr.send();	
		}
	}
}

//차량 등록 모달에서 save 클릭 시 발생하는 이벤트 함수
function fn_jobInsert(){
	// fSerialize(senderForm);
	
	var vhcleImgUrlFile = document.querySelector("#vhcleImgUrlFile").files[0];

	const vehicleVO = {};
	var vhcleModel = document.querySelector("#vhcleModel").value;
	var vhcleNo = document.querySelector("#vhcleNo").value;
	var vhcleCapacity = document.querySelector("#vhcleCapacity").value;

	vehicleVO.vhcleModel = vhcleModel;
	vehicleVO.vhcleNo = vhcleNo;
	vehicleVO.vhcleCapacity = vhcleCapacity;

	console.log("vehicleVO ==> " , vehicleVO);
	console.log("JSON.stringify(vehicleVO) ==> " , JSON.stringify(vehicleVO));

	const formData = new FormData();
	formData.append('file',vhcleImgUrlFile);
	formData.append('vehicleVO', new Blob([JSON.stringify(vehicleVO)], {type:'application/json;charset=utf-8'}));

	var xhr = new XMLHttpRequest();
	xhr.open("POST","/adVehicle", true);
	xhr.setRequestHeader(CSRFHEADERNAME, CSRFTOKEN);
	xhr.onreadystatechange = function(){
		if(xhr.readyState==4 && xhr.status==200){
			console.log("성공 ! ==> ", xhr.responseText);
			Swal.fire('신규차량이 등록되었습니다.', '','success').then((result)=>{
				location.reload();
			})
		}
	};
	xhr.send(formData);
}


$(function () {
	var vehicleList = document.querySelector("#vehicleList");
	new agGrid.Grid(vehicleList, gridOptions);
	getData();  // 데이터 불러오깅
});