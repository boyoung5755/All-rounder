/**
 * <pre>
 * 
 * </pre>
 * @author 작성자명
 * @since 2023. 11. 30.
 * @version 1.0
 * <pre>
 * [[개정이력(Modification Information)]]
 * 수정일        수정자       수정내용
 * --------     --------    ----------------------
 * 2023. 11. 30.      오경석       최초작성
 * Copyright (c) 2023 by DDIT All right reserved
 * </pre>
 */


function freeList() {

		console.log("!!")
	$.ajax({
		type: "get",
		url: "/free/list",
		contentType: "application/json; charset=UTF-8",
		dataType: "json",
		success: function(res) {
			let tag = res.paging.pagingHTML;
			let list = res.paging.dataList;
			if(list[0] != null){
				
				let freeboardList = "";
				
				list.forEach((item) => {
					let day = item.bbsRgsde;
					let date = `${day[0]}-${day[1]}-${day[2]}`;
	
					let html = `	
					<div class="col-sm-6 col-lg-4">	
						<div class="card p-2 h-100 shadow-none border">
							<div class="rounded-2 text-center mb-3">
								<a href="javascript:void(0);" onclick="selectFree(${item.bbsNo})"><img class="img-fluid" src="https://png.pngtree.com/png-vector/20191115/ourmid/pngtree-beautiful-profile-line-vector-icon-png-image_1990469.jpg" alt="tutor image 1"></a>
							</div>
							<div class="card-body p-3 pt-2">
								<div class="d-flex justify-content-between align-items-center mb-3 pe-xl-3 pe-xxl-0">
									<h6 class="d-flex align-items-center justify-content-center gap-1 mb-0">
										${item.empName} <span class="text-warning"><i class="bx bxs-star me-1"></i></span><span class="text-muted"> (${item.empCd})</span>
									</h6>
								</div>
								<a href="javascript:void(0);" onclick="selectFree(${item.bbsNo})" data-freeNo="${item.bbsNo}" id="freeBBSNo"class="h5" >${item.bbsSj}</a>
								<p class="mt-2">${item.bbsCn}</p>
								<p class="d-flex align-items-center">
									<i class="bx bx-time-five me-2"></i>${date}
								</p>
							</div>
						</div>	
					</div>			
					`;
					freeboardList += html;		
				});
				document.getElementById("freeboardList").innerHTML=freeboardList;
				//document.querySelector(".freePage").innerHTML=tag;				
			}

		},
		error: function(xhr) {
			alert("실패")
			console.log(xhr);
		}
	});

}
freeList();



function selectFree(bbsNo){
	console.log("1")
	console.log(document.getElementById("freeBBSNo"))
	let url = "/free/"+bbsNo;
	console.log(url)
	let empCd = document.getElementById("empCd");
	let jsondata = {
		"bbsNo":bbsNo
		}
console.log(jsondata)		
	$.ajax({
		type:"post",
		url:url,
		contentType: "application/json; charset=UTF-8",
		data:JSON.stringify(jsondata),
		dataType:"json",
		success:function(res){
			console.log(res)
			document.getElementById("freeboardList").style.display="none";
			document.getElementById("serachFree").style.display="none";
			
			let day = res.bbsRgsde;
			let date = `${day[0]}-${day[1]}-${day[2]}`;	
			
					
			let html = `

				    <!-- 수정, 삭제 기능 -->
				    <div id="editDelete">
				        <button id="editBtn">수정</button>
				        <button id="deleteBtn">삭제</button>
				    </div>


				<div class="d-flex justify-content-between align-items-center flex-wrap mb-2 gap-1">
					<div class="me-1" id="freeSelectNo">
						<h5 class="mb-1">(제목) ${res.bbsSj}</h5>
						<p class="mb-1" data-freeSelectNo="${res.bbsNo}">(게시판번호) ${res.bbsNo} <span class="fw-medium"> (작성자사번) </span></p>
					</div>
					<div class="d-flex align-items-center">
						<i class="bx bx-share-alt bx-sm mx-4"></i>
						<i class="bx bx-bookmarks bx-sm"></i>
					</div>
				</div>

				<div class="card academy-content shadow-none border">
					<div class="p-2">
						<div class="cursor-pointer">
							<div class="plyr plyr--full-ui plyr--video plyr--html5 plyr--fullscreen-enabled plyr--paused plyr--stopped plyr--pip-supported plyr__poster-enabled" style="border-radius: 7px;">
								<div class="plyr__video-wrapper">
									<img class="w-100" src="https://png.pngtree.com/png-vector/20191115/ourmid/pngtree-beautiful-profile-line-vector-icon-png-image_1990469.jpg" alt="tutor image 1">
								</div>
							</div>
						</div>
					</div>
					<div class="card-body">
						<h5 class="mb-2">제목</h5>
						<p class="mb-0 pt-1">${res.bbsSj}</p>
				
						<hr class="mb-4 mt-2">
						<h5>내용</h5>
						<p class="mb-4">${res.bbsCn}</p>
						<hr class="my-4">
						<h5>정보</h5>
						<div class="d-flex flex-wrap">
							<div class="me-5">
								<p class="text-nowrap">
									<i class="bx bx-check-double bx-sm me-2"></i>작성글번호 ${res.bbsNo}
								</p>
								<p class="text-nowrap">
									<i class="bx bx-user bx-sm me-2"></i>작성자 ${res.empName}
								</p>
								<p class="text-nowrap">
									<i class="bx bx-pencil bx-sm me-2"></i>작성자사번 ${res.empCd}
								</p>
								<p class="text-nowrap">
									<i class="bx bxs-watch bx-sm me-2"></i>작성날짜 ${date}
								</p>
								<p class="text-nowrap">
									<i class="bx bxs-flag-alt bx-sm me-2"></i>Languages: English
								</p>
								<p class="text-nowrap">
									<i class="bx bx-file bx-sm me-2"></i>Captions: Yes
								</p>
							</div>
							<div>
							</div>
						</div>
						<hr class="my-4">
						<h5>댓글</h5>
						<textarea id="answerReply" placeholder="댓글을 입력하세요"></textarea>
						<input type="button" value="추가" id="insertReply" onclick="insertReply()">
			
				`;
				let anser = res.anserList;
				console.log(anser)
				anser.forEach((v)=>{
					console.log(v.answerWrter)
					console.log(v.answerCn)
					console.log(v.answerRgsde)
					console.log(v.answerWrterName)
					console.log(v.answerCode)
					console.log(v.answerUpcode)
					console.log(v)
					let writer = v.answerWrter;
					console.log("----------------")				
					
					if(v.answerUpcode == null ){
						html += `
						<hr class="my-4">
						<div id="comments" class="comments">
						    <small class="text-nowrap" data-replyNo="${v.answerCode}">
								<i class="bx bx-user bx-sm me-2"></i> (작성코드) ${v.answerCode} , (작성자) ${v.answerWrterName}, (작성자사번) ${v.answerWrter}
							</small> 
							<small class="text-muted">(작성날짜) ${v.answerRgsde}
							</small>
							`;
							if(writer == empCd.value){
								html+= `
									<input type="button" value="수정" onclick="answerUpdate(this)" id="answerUpdate">
									<input type="button" value="삭제" onclick="answerDelete(this)" id="answerDelete">
								`;								
							}						
							html +=`
							<br />				
							<div id="textUpdate">		   
						    	<i class="bx bx-file bx-sm me-2"><p id="contentAnswer">(내용) ${v.answerCn} </p> 							
								</i> 
							</div><br /><br />
						    <textarea id="commentInput" placeholder="댓글을 입력하세요"></textarea>
						    <button onclick="postComment(this)" value="${v.answerCode}" id="reAnswer">댓글 작성</button>
						    
						
						

						`;	

			            anser.forEach((reply) => {
							let replyWriter = reply.answerWrter;
							if(reply.answerUpcode != null && v.answerCode == reply.answerUpcode){
								html += `
									<!-- 대댓글 입력 양식 -->
									<ul id="commentList">
										<div class="replyArea">
											<i class="bx bx-check-double bx-sm me-2" ></i>
											<span class="text-muted">작성자 ${reply.answerWrterName} (${reply.answerWrter}) / 작성일 : ${reply.answerRgsde}
											`;
											if(replyWriter == empCd.value){
												html+=`
													<input type="button" value="수정" onclick="replyUpdate(this)" id="replyUpdate">
													<input type="button" value="삭제" onclick="replyDelete(this)" id="replyDelete">		
													`;											
											}	
											html+=`													
											</span>
											<li data-answerCode="${reply.answerCode}">내용 : ${reply.answerCn}</li>
										</div>
									</ul>
								`;
							}
			            });
						
					}	
				})
				html += `
					
					</div>
				`;

			document.getElementById("freeboardSelect").innerHTML = html;
		},
		error:function(xhr){
			alert("2")
			console.log(xhr)
		}
		
	});
}

function insertReply(){
	console.log("%%%%");
	let empCd = document.getElementById("empCd").value;
	console.log(empCd);
	
	let text = document.getElementById("answerReply");
	console.log(text.value)

	let freeSelect = document.getElementById("freeSelectNo");
	let select = freeSelect.querySelector("p")
	let no = select.getAttribute("data-freeselectno");	
	console.log(no)
	
	let jsondata = {
		"answerCode" : no,
		"answerWrter" : empCd,
		"answerCn" : text.value,
		"bbsNo" : no
	}
	
	$.ajax({
		type:"post",
		url:"/free/answerInsert",
		contentType: "application/json; charset=UTF-8",
		data:JSON.stringify(jsondata),
		dataType:"text",
		success:function(res){
			console.log(res)
			
			selectFree(no);
		},
		error:function(xhr){
			alert("실패")
			console.log(xhr)
		}
	});
}



function submitCommentBtnRe(answerCode){
	document.getElementById("reAnswer").style.display="none";
	document.getElementById("replyForm").style.display="block";
	console.log(answerCode.value)

}

function submitReplyBtn(answerCode){
	let empCd = document.getElementById("empCd").value;
	console.log(empCd);
	console.log(answerCode.value)
	let commentForm = document.getElementById("replyForm");
	var textarea = commentForm.querySelector("textarea")
	var text = textarea.value
	console.log(text)
	let txtBox = document.querySelector(".txt-box");
	var h2Element = txtBox.querySelector("h2");
	var no = h2Element.getAttribute("data-bbscd");
	console.log(no)
	
	
	
	let jsondata = {
		"answerWrter":empCd,
		"answerCn" : text,
		"bbsNo" : no,
		"answerUpcode" : answerCode.value
		
	}
	console.log(jsondata)
	$.ajax({
		type:"post",
		url:"/free/replyInsert",
		contentType: "application/json; charset=UTF-8",
		data:JSON.stringify(jsondata),
		dataType:"json",
		success:function(res){
			console.log(res)
		},
		error:function(xhr){
			alert("실패")
			console.log(xhr)
		}
	});
}

// 댓글 작성 함수
function postComment(data) {
	console.log(data.value)
	console.log(data)
	console.log(this)
	
	let comments = document.getElementById("comments");
	console.log(comments)
	
	 // 해당 버튼의 부모 요소에서 textarea 찾기
    let textarea = data.parentNode.querySelector('textarea');
    
    // textarea의 값을 가져와서 출력 또는 활용
    let textareaValue = textarea.value;
    console.log(textareaValue);

	let empCd = document.getElementById("empCd").value;
	console.log(empCd);
		

	let freeSelect = document.getElementById("freeSelectNo");
	let select = freeSelect.querySelector("p")
	let no = select.getAttribute("data-freeselectno");	
	console.log(no)




	let jsondata = {
		"answerWrter":empCd,
		"answerCn":textareaValue,
		"bbsNo":no,
		"answerUpcode":data.value
	}
	
	console.log(jsondata)
	$.ajax({
		type:"post",
		url:"/free/replyInsert",
		contentType: "application/json; charset=UTF-8",
		data:JSON.stringify(jsondata),
		dataType:"text",
		success:function(res){
			console.log(res)
			selectFree(no);
		},
		error:function(xhr){
			alert("실패")
			console.log(xhr)
		}
	});

}

// 댓글 및 대댓글을 화면에 표시하는 함수
/*function displayComments() {
    const commentList = document.getElementById('commentList');
    commentList.innerHTML = '';

    comments.forEach((comment, index) => {
        const commentItem = document.createElement('li');
        commentItem.textContent = `${index + 1}. ${comment.text}`;

        if (comment.replies.length > 0) {
            const replyList = document.createElement('ul');
            comment.replies.forEach((reply, replyIndex) => {
                const replyItem = document.createElement('li');
                replyItem.textContent = `${index + 1}.${replyIndex + 1}. ${reply}`;
                replyList.appendChild(replyItem);
            });
            commentItem.appendChild(replyList);
        }

        commentList.appendChild(commentItem);
    });
}*/

function answerDelete(data){
	console.log(data)
	console.log(data.parentNode)
	let value = data.parentNode.querySelector('small');
	let answerCode = value.getAttribute("data-replyNo")
	console.log(value)
	console.log(answerCode)
	
	let empCd = document.getElementById("empCd");
	console.log(empCd.value)
	
	let freeSelect = document.getElementById("freeSelectNo");
	let select = freeSelect.querySelector("p")
	let no = select.getAttribute("data-freeselectno");	
	console.log(no)
	
	let jsondata = {
		"answerCode" : answerCode,
		"answerWrter" : empCd.value
	}
	console.log(jsondata)
	
	
	
	$.ajax({
		type:"DELETE",
		url:"/free/answerDelete",
		contentType: "application/json; charset=UTF-8",
		data:JSON.stringify(jsondata),
		dataType:"text",
		success:function(res){
			console.log(res)
			selectFree(no);
		},
		error:function(xhr){
			alert("실패")
			console.log(xhr)
		}
	});
}

function answerUpdate(data){
	

	let tag = data.parentNode.querySelector('p');
	console.log(data.parentNode)
	console.log(tag)
	
	let content = tag.innerHTML;
		
	let iTag = data.parentNode.querySelector('i');
	console.log(iTag)
	let html = `
		<textarea id="updateShow" placeholder="${content}"></textarea>
		<input type="button" value="수정" onclick="updateAnswer(this)" id="updateAnswer" />
	`;
	let textUpdate = data.parentNode.querySelector('div');
	console.log(textUpdate)
	textUpdate.innerHTML = html;
	
	let buttonUpdate = data.parentNode.querySelector('#answerUpdate');
	buttonUpdate.style.display="none";
	let buttonDelete = data.parentNode.querySelector('#answerDelete');
	buttonDelete.style.display="none";
	
}

function updateAnswer(data){
	let text = data.parentNode.querySelector("#updateShow").value;
	console.log(text)
	let empCd = document.getElementById("empCd");
	
	console.log(data.parentNode)
	console.log(data.parentNode.parentNode)
	let parent = data.parentNode.parentNode;
	let tag = parent.querySelector("small");
	console.log(tag.getAttribute("data-replyNo"))
	let answerUpcode = tag.getAttribute("data-replyNo");
	
	let freeSelect = document.getElementById("freeSelectNo");
	let select = freeSelect.querySelector("p")
	let no = select.getAttribute("data-freeselectno");	
	console.log(no)
	
	let jsondata = {
		"answerCn" : text,
		"answerWrter" : empCd.value,
		"answerCode" : answerUpcode
	}
	console.log(jsondata)
	
	$.ajax({
		type:"PUT",
		url:"/free/answerUpdate",
		contentType: "application/json; charset=UTF-8",
		data:JSON.stringify(jsondata),
		dataType:"text",
		success:function(res){
			console.log(res)
			selectFree(no);
		},
		error:function(xhr){
			alert("실패")
			console.log(xhr)
		}
	});
}