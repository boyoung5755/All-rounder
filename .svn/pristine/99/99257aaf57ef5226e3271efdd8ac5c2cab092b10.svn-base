<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.groupware.attendance.dao.AttendanceDAO">

	<resultMap type="AttendanceVO" id="aMap" autoMapping="true">
		<id property="attDate" column="ATT_DATE"/>
		<id property="empCd" column="EMP_CD"/>
		<collection property="alList" ofType="AttendanceLogVO" autoMapping="true"/>
	</resultMap>

	<select id="attendanceList" resultType="EmployeeVO">
		SELECT emp_cd
		FROM employee
	</select>
	
	<insert id="attendanceInsert" parameterType="AttendanceLogVO" useGeneratedKeys="true">
		<selectKey keyColumn="ATT_LOG_TIME,ATT_DATE" keyProperty="attLogTime,attDate" resultType="hashmap" order="BEFORE">
			SELECT TO_CHAR(SYSDATE,'HH24MISS') ATT_LOG_TIME, TO_CHAR(SYSDATE,'YYYYMMDD') ATT_DATE FROM DUAL
		</selectKey>
		INSERT INTO ATTENDANCE_LOG (
		    ATT_LOG,
		    ATT_LOG_TIME,
		    ATT_DATE,
		    EMP_CD
		) VALUES (
		    #{attLog},
		    #{attLogTime},
		    #{attDate},
		    #{empCd}
		)
	</insert>
	
	<select id="selectAttendance" resultType="AttendanceVO" parameterType="AttendanceVO">
		SELECT ATT_DATE
			, EMP_CD
			, START_TIME
			, END_TIME
			, sTime
		FROM
			(SELECT ATT_DATE
			, EMP_CD
			, START_TIME
			, END_TIME
			, SUBSTR(START_TIME,0,2)||':'||SUBSTR(START_TIME,3,2) sTime
			FROM ATTENDANCE
			WHERE EMP_CD=#{empCd}
			<![CDATA[
				AND ATT_DATE+1||'04'>TO_CHAR(SYSDATE,'YYYYMMDDHH24')
			]]>
			ORDER BY ATT_DATE DESC)
		WHERE ROWNUM=1
	</select>
	
	<select id="attendanceLogList" resultType="AttendanceLogVO" parameterType="AttendanceLogVO">
		SELECT ATT_LOG, ATT_LOG_TIME, ATT_DATE, EMP_CD, SUBSTR(ATT_LOG_TIME,0,2)||':'||SUBSTR(ATT_LOG_TIME,3,2) lTime
		FROM ATTENDANCE_LOG
		WHERE EMP_CD=#{empCd}
		<![CDATA[
			AND ATT_DATE+1||'04'>TO_CHAR(SYSDATE,'YYYYMMDDHH24') AND ATT_DATE||'04'<TO_CHAR(SYSDATE,'YYYYMMDDHH24') AND SUBSTR(ATT_DATE,7)||SUBSTR(ATT_LOG_TIME,0,2)>SUBSTR(ATT_DATE,7)||'04'
		]]>
		ORDER BY ATT_LOG_TIME ASC
	</select>
	
	<update id="commute" parameterType="AttendanceVO">
		MERGE INTO ATTENDANCE
		USING DUAL
		<![CDATA[
		ON (ATT_DATE+1||'04'>TO_CHAR(SYSDATE,'YYYYMMDDHH24') AND EMP_CD=#{empCd})
		]]>
		WHEN MATCHED THEN 
		    UPDATE SET END_TIME=TO_CHAR(SYSDATE,'HH24MISS')
		    WHERE ATT_DATE=TO_CHAR(SYSDATE,'YYYYMMDD')
		WHEN NOT MATCHED THEN
		    INSERT (ATT_DATE,EMP_CD,START_TIME)
		    VALUES(TO_CHAR(SYSDATE,'YYYYMMDD'),#{empCd},TO_CHAR(SYSDATE,'HH24MISS'))
	</update>
	
	<select id="attendanceWeek" parameterType="AttendanceVO">
		SELECT ATT_DATE, EMP_CD, START_TIME, END_TIME
        FROM ATTENDANCE
		<![CDATA[
        WHERE #{startOfWeek}<=ATT_DATE AND ATT_DATE<=#{endOfWeek}
        ]]>
       	AND END_TIME IS NOT NULL AND EMP_CD=#{empCd}
	</select>
	
	<select id="attendanceWeekly" parameterType="AttendanceVO">
		SELECT ATT_DATE, EMP_CD, START_TIME, END_TIME
        FROM ATTENDANCE
		<![CDATA[
        WHERE #{startOfWeek}<=ATT_DATE AND ATT_DATE<=#{endOfWeek}
        ]]>
        AND EMP_CD=#{empCd}
	</select>
	
	<select id="selectYearAnnual" parameterType="String" resultType="int">
		SELECT ANNUAL_YEAR
		FROM PAID_ANNUAL
		WHERE EMP_CD=#{empCd}
			AND PV_YEAR=TO_CHAR(SYSDATE,'YYYY')
	</select>
	
	<select id="selectAwardAnnual" parameterType="String" resultType="int">
		SELECT COUNT(ANN_NO)
		FROM AWARD_ANNUAL
		WHERE EMP_CD=#{empCd}
			AND SUBSTR(AA_GDAY,0,4) = TO_CHAR(SYSDATE,'YYYY')
	</select>
	
	<select id="selectHalfAnnual" parameterType="String" resultType="int">
		SELECT COUNT(V_SDAY)
		FROM VACATION
		WHERE EMP_CD=#{empCd}
			AND V_FLAG='H'
	</select>
	
	<select id="selectUseAnnaul" parameterType="String" resultType="int">
		SELECT V_EDAY-V_SDAY
		FROM VACATION
		WHERE EMP_CD=#{empCd}
			AND V_FLAG='N'
	</select>
	
	<select id="annualList" parameterType="String" resultType="AnnualVO">
		SELECT
			FN_GET_DEPT_NAME(EMP_CD) dept_name,
			FN_GET_EMP_RANK_NM(EMP_CD) rank_nm,
			FN_GET_EMP_NAME(EMP_CD) emp_name
		FROM VACATION
		<![CDATA[
		WHERE V_SDAY<=#{formattedToday} AND #{formattedToday}<V_EDAY
        ]]>
        AND EMP_CD=#{empCd}
	</select>
</mapper>





