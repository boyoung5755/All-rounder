<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form"%>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>
  <script src="/resources/js/app/qrcode/jsQR.js"></script> 
  
<%--
* [[ê°œì •ì´ë ¥(Modification Information)]]
* ìˆ˜ì •ì¼                 ìˆ˜ì •ì      ìˆ˜ì •ë‚´ìš©
* ----------  ---------  -----------------
* ${date}      ì‘ì„±ìëª…      ìµœì´ˆì‘ì„±
	2023-11-16	ê¶Œë„ìœ¤	ê·¼íƒœ ìˆ˜ì •
	2023-11-22	ê¹€ë³´ì˜	ë‚´ì¼ê°ì—°ê²°
	2023-11-28	ì†¡ì„ì› qrì½”ë“œ ì¸ì‹ë°ë°ì´í„° ì „ì†¡ 
* Copyright (c) ${year} by DDIT All right reserved
 --%>
 <style>
 
 .modal-content {
    width: auto;
}
  
/*   #loadingMessage, */
/*   #canvas, */
/*   #output { */
/*     display: none; */
/*   } */
   
/*     .qrbody {  */
/*       font-family: 'Ropa Sans', sans-serif; */
/*       color: #333; */
/*       max-width: 40px; */
/*       margin: 0 auto; */
/*       position: relative; */
/*     } */

    #githubLink {
      position: absolute;
      right: 0;
      top: 12px;
      color: #2D99FF;
    }

    h1 {
      margin: 10px 0;
      font-size: 40px;
    }

    #loadingMessage {
      text-align: center;
      background-color: #eee;
    }
 
    #canvas {
      width: 340px;
    }

    #output {
      margin-top: 20px;
      background: #eee;
      padding: 10px;
      padding-bottom: 0;
    }

    #output div {
      padding-bottom: 10px;
      word-wrap: break-word;
    }

    #noQRFound {
      text-align: center;
    }
  </style>
  

<!-- Layout wrapper -->
<security:csrfInput/>
<div class="layout-wrapper layout-content-navbar">
	<div class="layout-container">
		<!-- Layout container -->
		<div class="layout-page">

			<!-- Content wrapper -->
			<div>
				<!-- Content -->
				<h3 class="pb-1 mb-4 text-muted">${emp}ë‹˜ì•ˆë…•í•˜ì„¸ìš”</h3>

				<div class="row mb-5">
					<div class="col-md-6 col-lg-4">
						<h6 class="mt-2 text-muted">ë‚ ì”¨</h6>
						<div class="card mb-4">
							<div class="card-body" id="weather">
								<!--ì´ë¶€ë¶„ì—ì„œ ì‘ì—…-->

							</div>
						</div>
						<h6 class="mt-2 text-muted">í”„ë¡œí•„</h6>
						<div class="card mb-4">
							<div class="card-body">
								<!--ì´ë¶€ë¶„ì—ì„œ ì‘ì—…-->
							</div>
						</div>
						<h6 class="mt-2 text-muted">ê·¼íƒœ</h6>
						<div class="card mb-4" style="text-align: center;">
							<div class="card-body">
<!-- 								<button class="btn btn-label-primary" onclick="commute()" id="commute" style="width:70%; height: 50px;"> -->
<!-- 									<span class="tf-icons bx bx-pie-chart-alt me-1"></span> -->
<!-- 								</button> --> 
								 <button class="btn btn-label-primary" onclick="commute()" id="commute"  data-bs-toggle="modal" data-bs-target="#modalCenter" style="width:70%; height: 50px;">
								 	<span class="tf-icons bx bx-pie-chart-alt me-1"></span> 
                         		</button>
                       
							</div>
						</div>
					</div>
					<div class="col-md-6 col-lg-4">
						<h6 class="mt-2 text-muted">ê·¼íƒœí˜„í™©</h6>
						<div class="card mb-4">
							<div class="card-body" style="justify-content: center;">
								<!--ì´ë¶€ë¶„ì—ì„œ ì‘ì—…-->
								<div class="progress">
                      				<div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="progressbar">
                      				</div>
                    			</div>								
								<div class="text-muted d-block" style="text-align: center;">
									<small style="margin: 0 7%; font-size: 15px;">ì›”</small>'
									<small style="margin: 0 7%; font-size: 15px;">í™”</small>'
									<small style="margin: 0 7%; font-size: 15px;">ìˆ˜</small>'
									<small style="margin: 0 7%; font-size: 15px;">ëª©</small>'
									<small style="margin: 0 7%; font-size: 15px;">ê¸ˆ</small>
								</div>
								<div class="text-muted d-block" id="annualList">
								</div>
								<!--/ì´ë¶€ë¶„ì—ì„œ ì‘ì—…-->
							</div>
						</div>
						<h6 class="mt-2 text-muted">ë‚´ê²°ì¬</h6>
						<div class="card mb-4">
							<div class="card-body">
								<!--ì´ë¶€ë¶„ì—ì„œ ì‘ì—…-->
							</div>
						</div>
					</div>
					<div class="col-md-6 col-lg-4">
						<h6 class="mt-2 text-muted">ê³µì§€ì‚¬í•­</h6>
						<div class="card mb-4">
							<div class="card-body">
								<!--ì´ë¶€ë¶„ì—ì„œ ì‘ì—…-->
							</div>
						</div>
						<h6 class="mt-2 text-muted">ë‚´ ì¼ê°</h6>
						<div class="card mb-4">
							 <a class="nav-link dropdown-toggle" href="javascript:void(0);" data-bs-toggle="dropdown"
			                    aria-expanded="false" data-trigger="hover">
			                    <i class='bx bxs-copy-alt'></i>
			                    ã€€í”„ë¡œì íŠ¸</a>
			                  <div class="dropdown-menu">
			                    <c:forEach items="${proj}" var="proj">
			                      <c:if test="${proj.proSttus == 1}">
			                        <a  class="dropdown-item myproject" onclick="myjobGrid()" data-set-prosn="${proj.proSn}">${proj.proNm}</a>
			                      </c:if>
			                    </c:forEach>
			                  </div>
							<div class="card-body ag-theme-balham" id="myjobList" style="height:465px">
								<!--ì´ë¶€ë¶„ì—ì„œ ì‘ì—…-->
							</div>
						</div>
						<h6 class="mt-2 text-muted">ì˜¤ëŠ˜ì˜ ì—°ì°¨ì</h6>
						<div class="card mb-4">
							<div class="card-body">
								<!--ì´ë¶€ë¶„ì—ì„œ ì‘ì—…-->
							</div>
						</div>
					</div>
				</div>


				<!-- /Content -->
			</div>
			<!-- /Content wrapper -->
		</div>
		<!-- /Layout container -->
	</div>
	<!-- /Layout wrapper -->
</div>

 
 
<div class="col-lg-4 col-md-6">
                      <small class="text-light fw-medium">Vertically centered</small>
                      <div class="mt-3">
                        <!-- Button trigger modal -->
                       

                        <!-- Modal -->
                        <div class="modal fade" id="modalCenter" tabindex="-1" style="display: none;" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                              <div class="modal-body">
                               <div id="loadingMessage" class="qrbody card mb-4">ğŸ¥ 
										ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤(ì›¹ìº ì´ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤).</div>  
								  <canvas id="canvas" hidden></canvas> 
								  <div id="output" hidden>
								    <div id="outputMessage">No QR code detected.</div>
								    <div hidden><b>Data:</b> <span id="outputData"></span></div>
								  </div>
 
 
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>


<script src="/resources/js/app/weather/weather.js"></script>
<script src="/resources/js/app/attebdabce/attendance.js"></script>
<script>var __basePath = './';</script>
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/dist/ag-grid-community.min.js"></script>


<script>


function myjobGrid(){
	
}

/* ë‚´ì¼ê° AG-GRID */
const gridOptionsMy = {
  // define grid columns
  columnDefs: [
    { field: 'jobSn', headerName: 'ì¼ê°ë²ˆí˜¸', hide: "true" },
    { field: 'proSn', headerName: 'í”„ë¡œì íŠ¸ë²ˆí˜¸', hide: "true" },
    { field: 'jobSj', headerName: 'ì¼ê°ëª…' },
    { field: 'jobEdate', headerName: 'ë§ˆê°ì¼' },
    { field: 'jobPriort', headerName: 'ìš°ì„ ìˆœìœ„' 
  	  , cellRenderer: function (row) {
  		  if (row.data.jobPriort == "1") {
					return "<span class='text-danger'>ê¸´ê¸‰</span>";
				}else if(row.data.jobPriort == "2"){
					return "<span class='text-warning'>ë†’ìŒ</span>";
				}else if(row.data.jobPriort == "3"){
					return "<span class='text-primary'>ì¤‘ê°„</span>";
				}else if(row.data.jobPriort == "4"){
					return "<span class='text-success'>ë‚®ìŒ</span>";
				}
  	  }
    },
    { 
  	  field: 'jobStcd', headerName: 'ìƒíƒœ'
			, cellRenderer: function (row) {
				if (row.data.jobStcd == "1") {
					return "<span class='badge bg-label-success me-1'>ìš”ì²­</span>";
				}else if(row.data.jobStcd == "2"){
					return "<span class='badge bg-label-primary me-1'>ì§„í–‰</span>";
				}else if(row.data.jobStcd == "3"){
					return "<span class='badge bg-label-danger me-1'>í”¼ë“œë°±</span>";
				}else if(row.data.jobStcd == "4"){
					return "<span class='badge bg-label-warning me-1'>ë³´ë¥˜</span>";
				}else if(row.data.jobStcd == "5"){
					return "<span class='badge bg-label-info me-1'>ì™„ë£Œ</span>";
				}else{
					return "<span class='badge bg-label-secondary me-1'>ìƒìœ„</span>";
				}
				
			}  
    },
  ],
  rowHeight: 46,
  defaultColDef: {
    sortable: true,
    resizable: true,
    filter: true,
    width: 120,
  },
  pagination: true,
  paginationAutoPageSize: false,
  paginationPageSize: 7,
  onRowClicked: function (event) {
		console.log(event);
		location.href = "/job/"+event.data.proSn+"/"+event.data.jobSn+"/detail"
	}
};

document.addEventListener('DOMContentLoaded', function () {
  var gridDivMy = document.querySelector("#myjobList");
  new agGrid.Grid(gridDivMy, gridOptionsMy);
  
  let proSn = $('.myproject').data('setProsn');

  const httpRequestMy = new XMLHttpRequest();
  httpRequestMy.open('GET', '/job/'+proSn+'/myjob');
  httpRequestMy.send();

  httpRequestMy.onreadystatechange = function () {
    if (httpRequestMy.readyState === 4 && httpRequestMy.status === 200) {
      httpResultMy = JSON.parse(httpRequestMy.responseText);

      var json = [];
      for (var i = 0; i < httpResultMy.myjob.length; i++) {
        var obj = new Object();
        obj.jobSn = httpResultMy.myjob[i].jobSn;
        obj.proSn = httpResultMy.myjob[i].proSn;
        obj.jobSj = httpResultMy.myjob[i].jobSj;
        obj.jobSj = httpResultMy.myjob[i].jobSj;
        obj.jobEdate = httpResultMy.myjob[i].jobEdate;
        obj.jobPriort = httpResultMy.myjob[i].jobPriort;
        obj.jobStcd = httpResultMy.myjob[i].jobStcd;
        json.push(obj);
      }

      gridOptionsMy.api.setRowData(json);
    }
  };
});
 




// qrì½”ë“œ ì‹œì‘ 
  function commute() { 
 
	

var video = document.createElement("video");
var canvasElement = document.getElementById("canvas");
var canvas = canvasElement.getContext("2d");
var loadingMessage = document.getElementById("loadingMessage");
var outputContainer = document.getElementById("output");
var outputMessage = document.getElementById("outputMessage");
var outputData = document.getElementById("outputData");

// QR ì½”ë“œë¡œë¶€í„° ì½ì€ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
var qrCodeData = ""; // ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜ ì„ ì–¸

//qrCodeData ê°’ ì—…ë°ì´íŠ¸
function updateQRCodeData(data) {
  qrCodeData = data;
}

  function drawLine(begin, end, color) {
    canvas.beginPath();
    canvas.moveTo(begin.x, begin.y);
    canvas.lineTo(end.x, end.y);
    canvas.lineWidth = 4;
    canvas.strokeStyle = color;
    canvas.stroke();
    
 
  }
 
  

  // Use facingMode: environment to attemt to get the front camera on phones
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
    video.srcObject = stream;
    video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
    video.play();
    requestAnimationFrame(tick);
//     qrCodeData = code ? code.data : ""; // ì½”ë“œì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë³€ìˆ˜ì— ì €ì¥ 
  
  
  
  });
  function getCurrentTime() {
	  const now = new Date();
	  const hours = String(now.getHours()).padStart(2, '0'); // ì‹œê°„
	  const minutes = String(now.getMinutes()).padStart(2, '0'); // ë¶„
	  const seconds = String(now.getSeconds()).padStart(2, '0'); // ì´ˆ
	  
	  const currentTime = hours + ':' + minutes + ':' + seconds;
	  return currentTime;
	}
  const currentTime = getCurrentTime();

  function tick() {
    loadingMessage.innerText = "" 
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      loadingMessage.hidden = true;
      canvasElement.hidden = false;
      outputContainer.hidden = false;

      canvasElement.height = video.videoHeight;
      canvasElement.width = video.videoWidth;
      canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
      var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
      var code = jsQR(imageData.data, imageData.width, imageData.height, {
        inversionAttempts: "dontInvert",
      });
      if (code) {
        drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
        drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
        drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
        drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
         
        qrCodeData = code.data; // ì½”ë“œì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë³€ìˆ˜ì— ì €ì¥ 
        console.log(qrCodeData); // ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥ 
        
       
        
        let empCd = qrCodeData; 
           
        let qrsend = {
      		  "empCd":qrCodeData 
        }  
         
      		 console.log("íì•Œ ë°ì´í„° í™•ì¸:",	qrsend);  
             if(confirm("í˜„ì¬ ì‹œê°„ì€ " + currentTime + " ì…ë‹ˆë‹¤.")){
            	 $.ajax({
                     type: 'POST',
                     url: '/attendance/commute',   
                     contentType:"application/json;charset=utf-8",
                     data: JSON.stringify(qrsend), // empCdë¡œ ë°ì´í„° ì „ì†¡
                     dataType: 'text', 
                     success: function(response) {
                       console.log('QR ì½”ë“œ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.');
                       $('#modalCenter').modal('hide'); 
//                        myPopup.close();
                       	location.reload();    
                     },
                     error: function(xhr, status, error) {
                       // ìš”ì²­ ì‹¤íŒ¨ ì‹œì˜ ë™ì‘
                       console.error('ë°ì´í„° ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                      	alert("ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ë‹¤ì‹œ ì‹œë„í•´ ë³´ì„¸ìš”");
                     }
                   });//end ajax
             }
         
       
      } else {
        outputMessage.hidden = false;
        outputData.parentElement.hidden = true;
      }
    }
    requestAnimationFrame(tick);
    
    
  }
//   qrì½”ë“œ
  disableCamera();    
} 
$('#modalCenter').on('hidden.bs.modal', function () {
    disableCamera();
}); 
//ì¹´ë©”ë¼ ë¹„í™œì„±í™” í•¨ìˆ˜
  function disableCamera() {
    var video = document.querySelector("video");

    if (video && video.srcObject) {
        var stream = video.srcObject;
        var tracks = stream.getTracks();

        tracks.forEach(function(track) {
            track.stop();
        });

        video.srcObject = null;
    }
}

</script>  
