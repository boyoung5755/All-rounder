/**
 * <pre>
 * 전년 월별 대비 자원의 사용률
 * </pre>
 * @author 박민주
 * @since 2023. 12. 05
 * @version 1.0
 * <pre>
 * [[개정이력(Modification Information)]]
 * 수정일        수정자       수정내용
 * --------     --------    ----------------------
 * 2023. 12. 05. 박민주       최초작성
 * Copyright (c) 2023 by DDIT All right reserved
 * </pre>
 */
var context = document.getElementById('reservationChart').getContext('2d');

//chart 에 표시할 데이터 생성
function makeData(reserve, resp){
	
	const reservationCounts = {
		vhicleThisYear : {},
		vhicleLastYear : {},
		confroomThisYear : {},
		confroomLastYear : {}
	};

	const today = moment();
	let thisYear= today.format('YYYY');
	
	console.log(thisYear + " : 이건 올해");

	if(reserve === "vehicle"){ // 차량 리스트
		let reservationList = resp.vehicle;
		console.log("여기로 들어오나??");
		for(var i = 0; i < reservationList.length; i++) {
			let vhcleUseDate = moment(reservationList[i].vhcleUseDate);
			let vhcleUseYear = vhcleUseDate.format('YYYY'); // 예약이 발생한 연도
			let vhcleUseMonth = vhcleUseDate.format('MM'); // 예약이 발생한 월
			console.log(vhcleUseYear + " , " + vhcleUseMonth);
			if(vhcleUseYear === thisYear || vhcleUseYear === (thisYear - 1)) {
				// 연도가 올해거나 작년이면 월별로 카운트
				if(vhcleUseYear === thisYear) {
					reservationCounts.vhicleThisYear[`${vhcleUseMonth}월`] = (reservationCounts.vhicleThisYear[`${vhcleUseMonth}월`] || 0) + 1;
				} else {
					reservationCounts.vhicleLastYear[`${vhcleUseMonth}월`] = (reservationCounts.vhicleLastYear[`${vhcleUseMonth}월`] || 0) + 1;
				}
			}
		}
		return reservationCounts;
	} else { // 회의실 리스트
		let reservationList = resp.confroom;
		for(var i = 0; i < reservationList.length; i++) {
			let confDate = moment(reservationList[i].confDate);
			let confYear = confDate.format('YYYY'); // 예약이 발생한 연도
			let confMonth = confDate.format('MM'); // 예약이 발생한 월
			if(confYear === thisYear || confYear === (thisYear - 1)) {
				// 연도가 올해거나 작년이면 월별로 카운트
				if(confYear === thisYear) {
					reservationCounts.confroomThisYear[`${confMonth}월`] = (reservationCounts.confroomThisYear[`${confMonth}월`] || 0) + 1;
				} else {
					reservationCounts.confroomLastYear[`${confMonth}월`] = (reservationCounts.confroomLastYear[`${confMonth}월`] || 0) + 1;
				}
			}
		}
		return reservationCounts;
	}
}

function getMakeCharts(reserve){
	let thisyearLabel= "";
	let lastyearLabel= "";
	if(reserve=="vehicle"){
		thisyearLabel= "올해 월별 차량 사용 건수";
		lastyearLabel= "작년 월별 차량 사용 건수";
		$("#confChart").css("background-color","");
		$("#vehicleChart").css("background-color","yellow");
	
	}else{
		thisyearLabel= "올해 월별 회의실 사용 건수";
		lastyearLabel= "작년 월별 회의실 사용 건수";
		$("#vehicleChart").css("background-color","");
		$("#confChart").css("background-color","yellow");
	}
	
	$.ajax({
        type : "GET",
        url : `/analysis/monthlyUsageRateReserve/${reserve}`,
        contentType : "application/json; charset=utf-8",
        success : function(resp){
            let chartData = makeData(reserve, resp);
			if(reserve=="vehicle"){
				  var chart = new Chart($("#reservationChart"), {
		                type: 'bar',
		                data: {
		                    labels: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'], // 차량 예약 데이터의 월별 키 값 가져오기
		                    datasets: [
		                        {
		                            label: `${thisyearLabel}`,
		                            data: Object.values(chartData.vhicleThisYear),
		                            backgroundColor: 'rgba(105, 108, 255,  0.7)',
		                        },
								{
		                            label: `${lastyearLabel}`,
		                            data: Object.values(chartData.vhicleLastYear),
		                            backgroundColor: 'rgba(255, 171, 0, 0.7)',
		                        }
		                    ]
		                },
		                options: {
		                    scales: {
		                        yAxes: [
		                            {
		                                ticks: {
		                                    beginAtZero: true
		                                }
		                            }
		                        ]
		                    }
		                }
		            });
			}else{
				var chart = new Chart($("#reservationChart"), {
		                type: 'bar',
		                data: {
		                    labels: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'], // 차량 예약 데이터의 월별 키 값 가져오기
		                    datasets: [
		                        {
		                            label: `${thisyearLabel}`,
		                            data: Object.values(chartData.confroomThisYear),
		                            backgroundColor: 'rgba(105, 108, 255,  0.7)',
		                        },
								{
		                            label: `${lastyearLabel}`,
		                            data: Object.values(chartData.confroomLastYear),
		                            backgroundColor: 'rgba(255, 171, 0, 0.7)',
		                        }
		                    ]
		                },
		                options: {
		                    scales: {
		                        yAxes: [
		                            {
		                                ticks: {
		                                    beginAtZero: true
		                                }
		                            }
		                        ]
		                    }
		                }
		            });
			}
          
            
        },
        error : function(error){
            console.log("가져오기 실패" + error);
        }
	})
}

$(function(){
	getMakeCharts("confroom");
})

$("#confChart").on("click", function(){
	$("#reservationChart").empty();
	getMakeCharts("confroom");
});
$("#vehicleChart").on("click", function(){
	$("#reservationChart").empty();
	getMakeCharts("vehicle");
});
