<%--
* [[개정이력(Modification Information)]]
* 수정일       		수정자        수정내용
* ---------- 		---------  -----------------
* 2023. 11. 10.     김보영        최초작성
* 2023. 11. 14.     김보영        일감리스트
* Copyright (c) 2023 by DDIT All right reserved
--%>



<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form" %>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>        


<h1 class="mb-0">${proInfo.proNm}</h1><br>
<!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    <!-- Layout container -->
    <div class="layout-page">
      <!-- Content wrapper -->
      <div>
        <!-- Content -->
        <!-- navbar -->
        
        <div class="col-md-7 col-lg-7">
			<ul class="nav nav-pills mb-3 nav-fill" role="tablist">
			  <li class="nav-item" role="presentation">
			    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" 
                    aria-expanded="false" data-trigger="hover">
                    <i class='bx bxs-copy-alt'></i>
                    　프로젝트</a>
                  <div class="dropdown-menu">
                    <c:forEach items="${proj}" var="proj">
                      <c:if test="${proj.proSttus == 1}">
                        <a class="dropdown-item" href="/job/${proj.proSn}/home" >${proj.proNm}</a>
                      </c:if>
                    </c:forEach>
                  </div>
			  </li>
			  <li class="nav-item" role="presentation">
			    <a class="nav-item nav-link active" href="javascript:void(0)">
			    	<i class='bx bx-edit'></i>
			    　일감</a>
			  </li>
			  <li class="nav-item" role="presentation">
			    <a class="nav-item nav-link" href="/issue/${proSn}/home">
			    	<i class='bx bx-calendar-exclamation' ></i>
			    　이슈</a>
			  </li>
			  <li class="nav-item" role="presentation">
			   <a class="nav-item nav-link" href="/pms/gantt/${proSn}">
			   		<i class='bx bx-chart'></i>
			   　간트차트</a>
			  </li>
			  <li class="nav-item" role="presentation">
			    <a class="nav-item nav-link disabled" href="javascript:void(0)">
			    	<i class='bx bxs-doughnut-chart'></i>
			    　리더통계</a>
			  </li>
			</ul>
		</div>
        <!-- /navbar -->

        <!-- 일감 진행상태 -->
        <div class="card mb-4">
          <div class="card-widget-separator-wrapper">
            <div class="card-body card-widget-separator">
              <div class="row gy-4 gy-sm-1">
                <div class="col-sm-20 col-lg-20" style="width: 20%;">
                  <div class="d-flex justify-content-between align-items-start card-widget-1 border-end pb-3 pb-sm-0">
                    <div>
                      <h3 class="mb-2">${jobCnt.aaCnt}</h3>
                      <p class="mb-0">진행</p>
                    </div>
                    <div class="avatar me-sm-4">
                      <span class="avatar-initial rounded bg-label-secondary">
                        <i class="bx bx-calendar bx-sm"></i>
                      </span>
                    </div>
                  </div>
                  <hr class="d-none d-sm-block d-lg-none me-4">
                </div>
                <div class="col-sm-20 col-lg-20" style="width: 20%;">
                  <div class="d-flex justify-content-between align-items-start card-widget-2 border-end pb-3 pb-sm-0">
                    <div>
                      <h3 class="mb-2">${jobCnt.bbCnt}</h3>
                      <p class="mb-0">요청</p>
                    </div>
                    <div class="avatar me-lg-4">
                      <span class="avatar-initial rounded bg-label-secondary">
                        <i class="bx bx-check-double bx-sm"></i>
                      </span>
                    </div>
                  </div>
                  <hr class="d-none d-sm-block d-lg-none">
                </div>
                <div class="col-sm-20 col-lg-20" style="width: 20%;">
                  <div class="d-flex justify-content-between align-items-start card-widget-2 border-end pb-3 pb-sm-0">
                    <div>
                      <h3 class="mb-2">${jobCnt.ccCnt}</h3>
                      <p class="mb-0">피드백</p>
                    </div>
                    <div class="avatar me-lg-4">
                      <span class="avatar-initial rounded bg-label-secondary">
                        <i class="bx bx-check-double bx-sm"></i>
                      </span>
                    </div>
                  </div>
                  <hr class="d-none d-sm-block d-lg-none">
                </div>
                <div class="col-sm-20 col-lg-20" style="width: 20%;">
                  <div class="d-flex justify-content-between align-items-start border-end pb-3 pb-sm-0 card-widget-3">
                    <div>
                      <h3 class="mb-2">${jobCnt.ddCnt}</h3>
                      <p class="mb-0">보류</p>
                    </div>
                    <div class="avatar me-sm-4">
                      <span class="avatar-initial rounded bg-label-secondary">
                        <i class="bx bxs-hand bx-sm"></i>
                      </span>
                    </div>
                  </div>
                </div>
                <div class="col-sm-20 col-lg-20" style="width: 20%;">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h3 class="mb-2">${jobCnt.eeCnt}</h3>
                      <p class="mb-0">완료</p>
                    </div>
                    <div class="avatar">
                      <span class="avatar-initial rounded bg-label-secondary">
                        <i class="bx bx-message-check bx-sm"></i>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /일감 진행상태 -->

        <!--차트와 참여자-->
        <div class="row mb-5">
          <div class="col-md-3 col-lg-3">
            <div class="card mb-3">
              <div class="card-body">
                <h5 class="card-title"><i class='bx bxs-doughnut-chart bx-md mb-1'></i> 내 일감 상태</h5>
                <div>
                  <canvas id="jobChart" style="height:400px"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-5 col-lg-5">
            <div class="card  mb-3">
              <div class="card-body">
                <h5 class="card-title"><i class='bx bx-book-heart bx-md mb-1'></i> 내 일감</h5>
                 <div id="myjobList" class="ag-theme-balham" style="height:400px">
                 	<!-- agGrid -->
                </div>
<!--                 <div class="overflow-hidden ag-theme-alpine" style="height:400px;"> -->
<!--                 	해당 프로젝트의 나의 일감 비동기 출력 -->
<!--                 	<table class="table card-table"> -->
<!-- 		              <thead> -->
<!-- 		               <tr> -->
<!-- 		                 <th>일감명</th> -->
<!-- 		                 <th>진행도</th> -->
<!-- 		                 <th>마감일</th> -->
<!-- 		                 <th>우선순위</th> -->
<!-- 		                 <th>상태</th> -->
<!-- 		               </tr> -->
<!-- 		             </thead> -->
<!-- 		             <tbody id="myJob" class="table-border-bottom-0"> -->
<!-- 						일감리스트 비동기출력 -->
<!-- 		             </tbody> -->
<!-- 		           </table> -->
<!--                 </div> -->
              </div>
            </div>
          </div>
          <div class="col-md-4 col-lg-4">
            <div class="card  mb-3">
              <div class="card-body">
                <h5 class="card-title"><i class='bx bxs-face bx-md mb-1'></i> 참여자</h5>
                <div id="pMemberList" class="ag-theme-balham" style="height:400px">
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-xl-12 col-12" style="text-align: left;">
            <div class="card-body">
              <div class="block-ui-btn demo-inline-spacing">
                <button type="button" class="btn rounded-pill btn-label-primary" data-bs-toggle="modal"
                  data-bs-target="#backDropModal">
                  <span class="tf-icons bx bx-paper-plane me-1"></span>일감등록
                </button>
              </div>
            </div>
          </div>

          <!--일감테이블-->

        
         <hr class="my-0 mb-3 mt-2">
         <input type="hidden" class="divider-text" data-pro-sn="${proSn}"/> 
          <div class="table-responsive text-nowrap">
            <table class="table card-table">
              <thead>
                <tr>
                  <th>일감명</th>
                  <th>작성자</th>
                  <th>진행도</th>
                  <th>담당자</th>
                  <th>상태</th>
                  <th>마감일</th>
                </tr>
              </thead>
              <tbody id="jobList" class="table-border-bottom-0">
				<!-- 일감리스트 비동기출력 -->
              </tbody>
              <tfoot id="jobPaging">
              </tfoot>
            </table>
          </div>
        </div>
      </div>
      <!-- /Content -->
    </div>
    <!-- /Content wrapper -->
  </div>
  <!-- /Layout container -->
</div>
<!-- /Layout wrapper -->
<%-- <form method="get" id="searchForm" class="border" >
	<hidden name="searchType" readonly="readonly" placeholder="searchType"/>
	<hidden name="searchWord" readonly="readonly" placeholder="searchWord"/>
	<input type="hidden" name="page" readonly="readonly" placeholder="page"/>
</form> --%>

<!-- 일감등록 -->
<div class="modal fade" id="backDropModal" data-bs-backdrop="static" tabindex="-1" style="display: none;"
  aria-hidden="true">

  <div class="modal-dialog">
    <form action="/job/${proSn}/insert" id="jobInsertForm" class="modal-content" method="POST"  enctype="multipart/form-data">
      <security:csrfInput/>
      <input type="hidden" id="tempProSn" value='<c:out value="${proSn}"/>'/>
      <div class="modal-header">
        <h5 class="modal-title" id="backDropModalTitle"><i class='bx bxs-comment-add bx-md'></i> 일감등록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <hr>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col mb-3">
            <label  class="fw-medium"><i class='bx bxs-book-add bx-sm mb-1'></i> 상위일감 선택</label>
            <select   name ="jobuSn" class="form-select"  tabindex="0" id="jobuSn" required="required">
		        <c:if test="${role eq 'leader'}">
                  <option value="">(선택)</option>
				</c:if>
              <c:forEach items="${jobList}" var="uJob">
                  <option value="${uJob.jobSn}">${uJob.jobSj}</option>
              </c:forEach>
            </select>
            <input type="hidden" value="${uJob.jobSn}" id="insertTempUJob"/>
          </div>
        </div>
        <div class="row">
          <div class="col mb-3">
            <label for="nameBackdrop" class="fw-medium"><i class='bx bxs-book-alt bx-sm mb-1' ></i> 일감명</label>
            <input name="jobSj"  type="text" id="nameBackdrop" class="form-control" placeholder="일감제목을 입력하세요" required />
          </div>
        </div>
        <div class="row g-2" style="text-align: center; display:none" id="jobStcdDiv" >
        <input id="jobStcd" type="hidden" name="jobStcd" value=""/>
          <div class="col mb-3">
          <button onclick="fn_jobStcd('1', this)" type="button" class="btn-jobStcd btn rounded-pill btn-label-success">요청</button>
        </div>
        <div class="col mb-3">
          <button onclick="fn_jobStcd('2', this)" type="button" class="btn-jobStcd btn rounded-pill btn-label-primary">진행</button>
        </div>
        <div class="col mb-3">
          <button onclick="fn_jobStcd('3', this)" type="button"  class="btn-jobStcd btn rounded-pill btn-label-danger">피드백</button>
        </div>
        <div class="col mb-3">
          <button onclick="fn_jobStcd('4', this)" type="button" class="btn-jobStcd btn rounded-pill btn-label-warning">보류</button>
        </div>
        <div class="col mb-3">
          <button onclick="fn_jobStcd('5', this)" type="button" class="btn-jobStcd btn rounded-pill btn-label-info">완료</button>
        </div>
        </div>
        <div class="row g-2">
          <div class="col mb-3">
            <label for="dobBackdrop" class="fw-medium"><i class='bx bx-calendar-edit bx-sm mb-1'></i> 시작일</label>
            <input name="jobBdate" type="date" id="dobBackdrop" class="form-control" required>
          </div>
          <div class="col mb-3">
            <label for="dobBackdrop" class="fw-medium"><i class='bx bx-calendar-exclamation bx-sm mb-1'></i> 종료일</label>
            <input name="jobEdate" type="date" id="dobBackdrop" class="form-control" required>
          </div>
        </div>
        <div class="row g-2">
          <div class="col mb-3">
            <label for="dobBackdrop" class="fw-medium"><i class='bx bx-edit bx-sm mb-1' ></i> 내용</label>
            <textarea name="jobCn" rows="5" cols="20" id="jobCn" class="form-control" ></textarea>
          </div>
        </div>
        <div class="row g-2">
          <div class="col mb-3">
            <label for="dobBackdrop" class="fw-medium"><i class='bx bx-file-find bx-sm mb-1'></i> 첨부파일</label>
            <input type="file" class="form-control" id="insertJobFiles" name ="jobFile" multiple />
            <div id="fileList"></div>
          </div>
        </div>
        <div class="row g-2">
	      	<div class="col mb-3">
	            <label for="nameBackdrop" class="fw-medium d-block" ><i class='bx bx-universal-access bx-sm mb-1'></i> 담당자</label>
	             <c:if test="${not empty proM }">
	                <c:forEach items="${proM}" var="proM" varStatus="i">
	                  <div class=" col mx-2 form-check custom-option custom-option-basic mb-3 checked d-inline-block">
                         <label class="form-check-label custom-option-content" for="proM${i.index }">
                           <input class="form-check-input insertchar" type="checkbox" id="proM${i.index }" name="tempEmpCd" value="${proM.emp.empCd}">
                           <span class="custom-option-header pb-0">
                             <span class="fw-medium">${proM.emp.empName}</span>
                           </span>
                         </label>
                       </div>
	                </c:forEach>
	              </c:if>
	          </div>
        </div>
        <div class="row g-2" id="jobprogDiv" >
          <div class="col mb-3">
            <label for="nameBackdrop" class="fw-medium"><i class='bx bx-objects-horizontal-left bx-sm mb-1'></i> 진행도</label>
            <select name ="jobProgrs" class="form-select" tabindex="0" id="roleEx4">
                <c:forEach begin="0" end="100" step="10" var="percentage" varStatus="loop">
                  <option value="${percentage}">${percentage}%</option>
                </c:forEach>
            </select>
          </div>
          <div class="col mb-3">
            <label for="nameBackdrop" class="fw-medium"><i class='bx bx-error-circle bx-sm mb-1'></i> 우선순위</label>
            <select name ="jobPriort" class="form-select" tabindex="0" id="roleEx4">
              <option value="1">긴급</option>
              <option value="2" >높음</option>
              <option value="3"selected>보통</option>
              <option value="4">낮음</option>
            </select>
            <input type="hidden" value="${proSn }" name="proSn"> 
            <input type="hidden" value="" name="jobSn"> 
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">
          Close 
        </button>
        <button type="button" onclick="fn_jobInsert()" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>






<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>var __basePath = './';</script>
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@30.2.1/dist/ag-grid-community.min.js"></script>
<script type="text/javascript" src="${pageContext.request.contextPath}/resources/js/app/job/job.js"></script>

<script>

  //상위일감 선택시에는 상태버튼 안보이기.
  $('#jobuSn').on("change", function(){
    if($(this).val() ==""){
      $('#jobStcdDiv').hide();
      $('#jobStcd').prop("disabled",true);

    }else {
      $('#jobStcdDiv').show();
      $('#jobStcd').prop("disabled",false);
    } 
  });

	
	
  /*chart.js  */
  document.addEventListener("DOMContentLoaded", function () {

    const ctx = document.querySelector('#jobChart');
    const data = {
      labels: [
        '요청',
        '진행',
        '피드백',
        '보류',
        '완료'
      ],
      datasets: [{
        label: '내 일감 상태',
        data: [${ jobCnt.aaCnt }, ${ jobCnt.bbCnt }, ${ jobCnt.ccCnt }, ${ jobCnt.ddCnt }, ${ jobCnt.eeCnt }],
        backgroundColor: [
          'rgb(232, 250, 223)',
          'rgb(231, 231, 255)',
          'rgb(255, 224, 219)',
          'rgb(255, 242, 214)',
          'rgb(215, 245, 252)'
        ],
        hoverOffset: 4
      }]
    };

    const jobChart = new Chart(ctx, {
      type: 'doughnut',
      data: data
    });
  })



  /* 참여자 AG-GRID */
  const gridOptions = {
    // define grid columns
    columnDefs: [
      { 
    	  field: 'empProfileImg', headerName: '사진'
  			, cellRenderer: function (row) {
  				if (row.data.empProfileImg != null) {
  					return "<img src='" + row.data.empProfileImg + "' style='height: 80%;'/>";
  				}else{
  					return "<img src='/resources/images/basic.png' style='height: 80%;'/>";
  				}
  			}  
      },
      { field: 'proLeader', headerName: '구분' },
      { field: 'deptName', headerName: '부서' },
      { field: 'empName', headerName: '이름' },
    ],
    rowHeight: 47,
    defaultColDef: {
      sortable: true,
      resizable: true,
      filter: true,
      width: 90,
    },
    pagination: true,
    paginationAutoPageSize: false,
    paginationPageSize: 7
  };

  document.addEventListener('DOMContentLoaded', function () {
    var gridDiv = document.querySelector("#pMemberList");
    new agGrid.Grid(gridDiv, gridOptions);


    const httpRequest = new XMLHttpRequest();
    httpRequest.open('GET', '/job/${proSn}/pMemberList');
    httpRequest.send();

    httpRequest.onreadystatechange = function () {
      if (httpRequest.readyState === 4 && httpRequest.status === 200) {
        httpResult = JSON.parse(httpRequest.responseText);

        var json = [];
        for (var i = 0; i < httpResult.proM.length; i++) {
          var obj = new Object();
          obj.empProfileImg = httpResult.proM[i].emp.empProfileImg;
          obj.proLeader = (httpResult.proM[i].proLeader === 'N') ? '팀원' : '리더';
          obj.deptName = httpResult.proM[i].emp.dept.deptName;
          obj.empName = httpResult.proM[i].emp.empName;
          json.push(obj);
        }

        gridOptions.api.setRowData(json);
      }
    };
  });
  
  
  
  /* 내일감 AG-GRID */
  const gridOptionsMy = {
    // define grid columns
    columnDefs: [
      { field: 'jobSn', headerName: '일감번호', hide: "true" },
      { field: 'proSn', headerName: '프로젝트번호', hide: "true" },
      { field: 'jobSj', headerName: '일감명' },
      { field: 'jobEdate', headerName: '마감일' },
      { field: 'jobPriort', headerName: '우선순위' 
    	  , cellRenderer: function (row) {
    		  if (row.data.jobPriort == "1") {
					return "<span class='text-danger'>긴급</span>";
				}else if(row.data.jobPriort == "2"){
					return "<span class='text-warning'>높음</span>";
				}else if(row.data.jobPriort == "3"){
					return "<span class='text-primary'>중간</span>";
				}else if(row.data.jobPriort == "4"){
					return "<span class='text-success'>낮음</span>";
				}
    	  }
      },
      { 
    	  field: 'jobStcd', headerName: '상태'
  			, cellRenderer: function (row) {
  				if (row.data.jobStcd == "1") {
  					return "<span class='badge bg-label-success me-1'>요청</span>";
  				}else if(row.data.jobStcd == "2"){
  					return "<span class='badge bg-label-primary me-1'>진행</span>";
  				}else if(row.data.jobStcd == "3"){
  					return "<span class='badge bg-label-danger me-1'>피드백</span>";
  				}else if(row.data.jobStcd == "4"){
  					return "<span class='badge bg-label-warning me-1'>보류</span>";
  				}else if(row.data.jobStcd == "5"){
  					return "<span class='badge bg-label-info me-1'>완료</span>";
  				}else if(row.data.jobuSn == null){
  					return "<span class='badge bg-label-secondary me-1'>상위</span>";
  				}else{
  					return "";
  				}
  				
  			}  
      },
    ],
    rowHeight: 46,
    defaultColDef: {
      sortable: true,
      resizable: true,
      filter: true,
      width: 120,
    },
    pagination: true,
    paginationAutoPageSize: false,
    paginationPageSize: 7,
    onRowClicked: function (event) {
		console.log(event);
		location.href = "/job/"+event.data.proSn+"/"+event.data.jobSn+"/detail"
	}
  };

  document.addEventListener('DOMContentLoaded', function () {
    var gridDivMy = document.querySelector("#myjobList");
    new agGrid.Grid(gridDivMy, gridOptionsMy);
    
    let proSn = $('.divider-text').data('pro-sn');

    const httpRequestMy = new XMLHttpRequest();
    httpRequestMy.open('GET', '/job/'+proSn+'/myjob');
    httpRequestMy.send();

    httpRequestMy.onreadystatechange = function () {
      if (httpRequestMy.readyState === 4 && httpRequestMy.status === 200) {
        httpResultMy = JSON.parse(httpRequestMy.responseText);

        var json = [];
        for (var i = 0; i < httpResultMy.myjob.length; i++) {
          var obj = new Object();
          obj.jobSn = httpResultMy.myjob[i].jobSn;
          obj.proSn = httpResultMy.myjob[i].proSn;
          obj.jobSj = httpResultMy.myjob[i].jobSj;
          obj.jobSj = httpResultMy.myjob[i].jobSj;
          obj.jobEdate = httpResultMy.myjob[i].jobEdate;
          obj.jobPriort = httpResultMy.myjob[i].jobPriort;
          obj.jobStcd = httpResultMy.myjob[i].jobStcd;
          json.push(obj);
        }

        gridOptionsMy.api.setRowData(json);
      }
    };
  });
  
  
  

</script>