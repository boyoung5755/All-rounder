<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<%@ taglib uri="http://tiles.apache.org/tags-tiles" prefix="tiles"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>
<%@ taglib uri="http://www.springframework.org/tags/form"  prefix="form"%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<%--
* [[개정이력(Modification Information)]]
* 수정일                 수정자      수정내용
* ----------  ---------  -----------------
* Nov 21, 2023      송석원      최초작성
* Copyright (c) 2023 by DDIT All right reserved
 --%> 
 
 <style>
 	.table:not(.table-dark) th {
    color: #566a7f;
    font-size: 17px;
    }
    .offcanvas, .offcanvas-xxl, .offcanvas-xl, .offcanvas-lg, .offcanvas-md, .offcanvas-sm {
    --bs-offcanvas-width: 900px;
    }
/*      .test{  */
/*      	border: 1px solid black;  */
/*      }  */ 
    
    .wd50 {width:50% !important;}
    .wd100 {width:100% !important;}
    .ft-left{float:left;}
 </style>
 
<div class="card">
	<div class="card-header border-bottom">
		<h4 class="card-title">프로젝트 관리</h4>
		<div class="d-flex justify-content-between align-items-center row py-3 gap-3 gap-md-0">
			<div class="col-md-4 user_role"></div>
			<div class="col-md-4 user_plan"></div>
			<div class="col-md-4 user_status"></div> 
		</div>
	
		
		<div class="col-lg-3 col-md-6">
                      <div class="mt-3">
                        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasEnd" aria-controls="offcanvasEnd">
                          <span>
						<i class="bx bx-plus me-0 me-sm-1"></i>
						<span class="d-none d-sm-inline-block">프로젝트 생성</span>
					</span>
                        </button>
                        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasEnd" aria-labelledby="offcanvasEndLabel">
                          <div class="offcanvas-header">
                            <h5 id="offcanvasEndLabel" class="offcanvas-title">프로젝트 생성</h5>
                            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                          </div>
                          <div class="offcanvas-body  mx-0 flex-grow-0">
                          
     
		<form  id="byForm" action="/adminproject" method="POST" > 
			<div class="modal-body"  >
				<div class="row">
					<div class="col mb-3 test" style="height: 700px; overflow-y: auto;">
						<div id="orgTreeContainer"></div>
						
					</div>
					<div class="col mb-0 test">
						
						<br />
						 프로젝트명 <br />
						<input type="text" class="form-control" id="proNm" name="proNm"/><br>  
						
			
						프로젝트 시작일<br>
						  <input type="date" class="form-control" id="proBdate" name="proBdate" value="" required><br>
						  
						  
						  프로젝트 종료일 <br> 
						  <input type="date" class="form-control" id="proEdate" name="proEdate" value="" required><br> <br>
						 
						<div class="d-flex align-items-center justify-content-between">
        						<h5>참여자 명단</h5>
        						<button type="button" id="remove" class="btn btn-primary">비우기</button>
   						</div>
   						<hr>
						<div id="orgTreeResult" style="height: 360px; overflow-y: auto;"></div>
					</div>
				</div> 
			</div>  
			                  
                            <button type="submit" class="btn btn-primary mb-2 d-grid w-100"  id="pbtn4">프로젝트 생성</button> 
						 <security:csrfInput/>
						</form>
						
                            <button type="button" class="btn btn-label-secondary d-grid w-100" data-bs-dismiss="offcanvas">
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
		<br />
	
		<div class="card-datatable table-responsive">
			<table class="table">
				<thead class="table-light">
					<tr>
						<th>상태</th> 
						<th >프로젝트명</th> 
						<th>리더사번</th>
						<th>리더명</th>
						<th>팀원수</th>
						<th>상위일감수</th>
						<th>하위일감수</th>
						<th>프로젝트 기간</th>
						<th><div style="margin-left: 17px;">수정</div></th> 
					</tr>
				</thead>
				<tbody class="table-border-bottom-0">
					<c:if test="${empty paging.dataList }">
						<tr> 
							<td colspan="6">검색 조건에 맞는 게시글 없음 </td>
						</tr>
					</c:if>
					<c:if test="${not empty paging.dataList }">
						<c:forEach	items="${paging.dataList }" var="adproj">
							<tr>
								<td>
						            <c:choose>
						                <c:when test="${adproj.proSttus eq 1}">진행</c:when>
						                <c:when test="${adproj.proSttus eq 2}">보류</c:when>
						                <c:when test="${adproj.proSttus eq 3}">완료</c:when>
						                <c:otherwise>상태 미정</c:otherwise>
						            </c:choose>
						        </td> 
								<td > 
 									<a href="<c:url value='/adminproject/${adproj.proSn}'/>"> 
 						                ${adproj.proNm} 
						            </a>  
							</td>				
								<c:forEach	items="${adproj.pjobList}" var="pjoblt">
								
								<c:forEach	items="${pjoblt.chargerList}" var="projld">
								<c:forEach	items="${adproj.pmemberList}" var="pmemc">
									<td>	${projld.empCd}</td> 
									<td>	${projld.empLeadername}</td>
									<td>${pmemc.pmemCount }</td>
									<td>${pjoblt.upperJobcount }</td>
									<td>${pjoblt.lowerJobcount }</td>
								</c:forEach>
								</c:forEach>
								</c:forEach>				
								<td>${adproj.proBdate } ~ ${adproj.proEdate}</td>	
								<td>
									<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#smallModalProj">
                         				 수정
                        			</button>
								</td>			
							</tr>
						</c:forEach>
					</c:if>
				</tbody>
				<tfoot>
					<tr>
						<td colspan="5">
							${paging.pagingHTML }
							<div id ="searchUI" class="row g-3 d-flex justify-content-center">
								<div class="col-auto">
									<form:select path = "simpleCondition.searchType" class="form-select"> 
										<form:option label="전체" value="" />
										<form:option label="제목" value="title" />
									</form:select>
								</div>
								<div class="col-auto">
								<form:input path="simpleCondition.searchWord" placeholder="검색키워드" class="form-control" />
								</div>
								<div class="col-auto">
								<input type="button" value="검색" id="searchBtn" class="btn btn-primary" />
								</div>
							</div>
						</td>
					</tr>
				</tfoot>
			</table>
		</div> 
	</div>
</div>





<!-- 모달창-->
<div class="modal fade" id="smallModalProj" tabindex="-1"
	style="display: none;" aria-hidden="true">
	<div class="modal-dialog modal-sm" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel2">프로젝트 수정</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div> 
					<div class="col mb-0 wd100">
						<label for="nameSmall" class="form-label">프로젝트명</label> <input 
							type="text" id="projectName" class="form-control"
							placeholder="">  
					</div>
					
					<div class="col mb-0 wd100 mt-2">
						<label for="nameSmall" class="form-label">리더사원코드</label>
						<select id="selLeader" >
						
						</select>
<!-- 						 <input -->
<!-- 							type="text" id="leaderName" class="form-control" -->
<!-- 							placeholder="">   -->
					</div>
					
				</div>
				<div class="row g-2 mt-2">
					<div class="col mb-0 wd50 ft-left">
						<label class="form-label" for="emailSmall">시작예정일</label> <input
							 id="PRO_BDATE" type="date" class="form-control " value="${adproj.proBdate}" > 
							 
					</div>
					<div class="col mb-0 wd50 ft-left">
						<label for="dobSmall" class="form-label">종료예정일</label> <input
							id="PRO_RDATE" type="date" class="form-control" value="${adproj.proEdate }">
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-label-secondary"
					data-bs-dismiss="modal">닫기</button>
				<button type="button" class="btn btn-primary">수정하기</button> 
			</div>
		</div>
	</div>
</div>

  



<!-- 히든태그 사용 -->
<form:form modelAttribute="simpleCondition" method="get" id = "searchForm" class = "border" >
	<form:hidden path="searchType" readonly="readonly" placeholder="searchType"/>
	<form:hidden path="searchWord" readonly="readonly" placeholder="searchWord"/>
	<input type="hidden" name="page" readonly="readonly" placeholder="page"/>
</form:form>

<script>



	//YY.MM.DD 형식의 날짜를 YYYY-MM-DD 형식으로 변환하는 함수
	function formatDateToISO(dateString) {
	    // dateString을 "."을 기준으로 분리하여 배열로 만듭니다.
	    var parts = dateString.split('.');
	    
	    // parts 배열에서 연, 월, 일을 추출합니다.
	    var year = parseInt(parts[0], 10) + 2000; // 년도는 2000을 더해줘야 합니다.
	    var month = parts[1];
	    var day = parts[2];
	
	    // 날짜를 YYYY-MM-DD 형식으로 반환합니다.
	    return year + '-' + month + '-' + day;
	}
	 
	// 클릭 이벤트 핸들러 내에서 날짜 형식 변경하기
	$(document).on('click', '.btn-warning', function() {
	    var projectName = $(this).closest('tr').find('td:nth-child(2)').text().trim();
	    var leaderName = $(this).closest('tr').find('td:nth-child(3)').text().trim();
	    var dateRange = $(this).closest('tr').find('td:nth-child(8)').text().trim();
	
	    console.log('Project Name:', projectName);
	    console.log('Leader Name:', leaderName);
	    console.log('Date Range:', dateRange);
	
	    // Date Range를 "YY.MM.DD ~ YY.MM.DD"에서 시작날짜와 종료날짜로 분리
	    var dates = dateRange.split(' ~ ');
	    var startDate = formatDateToISO(dates[0]);
	    var endDate = formatDateToISO(dates[1]);
	
	    console.log('Formatted Start Date:', startDate);
	    console.log('Formatted End Date:', endDate);
	
	    // 모달에 데이터 설정
	    $('#projectName').val(projectName);
	    $('#leaderName').val(leaderName);
	    $('#PRO_BDATE').val(startDate);
	    $('#PRO_RDATE').val(endDate);
	}); 






	const byForm = document.querySelector("#byForm");

	byForm.addEventListener("submit",()=>{
		event.preventDefault();

		 const pmemberList = [];
		 const pMems = byForm.querySelectorAll("[name=pMember]");
		 console.log("체크:",pMems); 

		 for(let i=0; i< pMems.length; i++){
			let pMemVO = {
				empCd: pMems[i].value
			}
			pmemberList.push(pMemVO);
		 }

		// 개발모드에서는 항상 필요한 데이타가 보이도록 프로그램
		let projVO = {
		 	proNm:byForm.proNm.value,	
 			proBdate:byForm.proBdate.value,		
 			proEdate:byForm.proEdate.value,	
			pmemberList:pmemberList
		}
        
		console.log("projVO",projVO);

		$.ajax({
			type:"post",
			url:"/adminproject",
			contentType:"application/json",
			data: JSON.stringify(projVO),
			dataType:"text",
			success:function(resp){
				console.log("체크:",resp);
				location.reload();
			},
			error:function(xhr){
				console.log("Error:",xhr.status);
			}
		})


	})



	function fn_paging(page) {
		searchForm.page.value = page;
		searchForm.requestSubmit();
	}
	$(searchUI).on("click", "#searchBtn", function(event){
		let inputs = $(this).parents("#searchUI").find(":input[name]");
		$.each(inputs, function(idx, ipt){
			let name = ipt.name;
			let value = $(ipt).val();
			$(searchForm).find(`:input[name=\${name}]`).val(value);
			$(searchForm).submit();
		});
	});

</script>  
<script src="${pageContext.request.contextPath }/resources/js/app/adproject/addproject.js"></script> 
