<%--
* [[개정이력(Modification Information)]]
* 수정일                 수정자      수정내용
* ----------  ---------  -----------------
* Nov 22, 2023      송석원      최초작성
* Copyright (c) 2023 by DDIT All right reserved
 --%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form" %>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>    






<div class="card">
	<div class="card-header border-bottom">
		<h4 class="card-title">프로젝트 멤버관리</h4>
		<div class="d-flex justify-content-between align-items-center row py-3 gap-3 gap-md-0">
			<div class="col-md-4 user_role"></div>
			<div class="col-md-4 user_plan"></div>
			<div class="col-md-4 user_status"></div> 
		</div>
	
		
		<div class="col-lg-3 col-md-6">
                      <div class="mt-3">
                        <button class="btn btn-primary" type="button">
                          <span>
						<i class="bx bx-plus me-0 me-sm-1"></i>
						<span class="d-none d-sm-inline-block">멤버 추가생성</span>
					</span>
                        </button>
                        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasEnd" aria-labelledby="offcanvasEndLabel">
                          <div class="offcanvas-header">
                            <h5 id="offcanvasEndLabel" class="offcanvas-title">프로젝트 생성</h5>
                            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                          </div>
                          <div class="offcanvas-body  mx-0 flex-grow-0">
                          
     
		<form  id="byForm" action="/adminproject" method="POST" > 
			<div class="modal-body">
				<div class="row">
					<div class="col mb-3 test">
						제1영역
						<div id="orgTreeContainer"></div>
						사원, 부서 검색영역
					</div>
					<div class="col mb-0 test">제2영역
						<button type="button" id="remove">비우기</button>
						<br />
						 프로젝트명 <br />
						<input type="text" id="proNm" name="proNm"/><br>  
						프로젝트 시작일<br>
						  <input type="date" id="proBdate" name="proBdate" value="" required><br>
						  프로젝트 종료일 <br> 
						  <input type="date" id="proEdate" name="proEdate" value="" required><br> <br>
						<h5>참여자 명단</h5>
						<hr>
						<div id="orgTreeResult"></div>
					</div>
				</div>
			</div>  
			                  
                            <button type="submit" class="btn btn-primary mb-2 d-grid w-100"  id="pbtn4">프로젝트 생성</button> 
						 <security:csrfInput/>
						</form>
						
                            <button type="button" class="btn btn-label-secondary d-grid w-100" data-bs-dismiss="offcanvas">
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
		<br />
	
		<div class="card-datatable table-responsive">
			<table class="table">
				<thead class="table-light">
					<tr>
						<th>프로필사진</th> 
						<th >사번</th> 
						<th>이름</th>
						<th>부서</th>
						<th>이메일</th>
						<th>내선번호</th>
						<th>휴대폰번호</th>
						<th>역할</th>
						<th style="padding-left: 65px;">삭제</th> 
					</tr>
				</thead>
				<tbody class="table-border-bottom-0">
					<c:if test="${empty paging.dataList }">
						<tr> 
							<td colspan="6">검색 조건에 맞는 게시글 없음 </td>
						</tr>
					</c:if>
					<c:if test="${not empty paging.dataList }">
								
								<c:forEach items="${paging.dataList }" var="adchar">
								<tr>
								<c:if test="${not empty adchar.emp.empProfileImg }">
									<td><img src='${adchar.emp.empProfileImg }' style='height: 46px; width:46px;' /></td>
								</c:if>
								<c:if test="${empty adchar.emp.empProfileImg }">
									<td><img src='/resources/images/basic.png' style='height: 46px; width:46px;' /></td>
								</c:if>
									
									<td>${adchar.emp.empCd }</td>
									<td>${adchar.emp.empName }</td>
									<td>${adchar.emp.deptCd }</td>
									<td>${adchar.emp.empMail }</td>
									<td>${adchar.emp.empExtension }</td>
									<td>${adchar.emp.empTelno }</td>
									
									<td>
										<c:choose>
							                <c:when test="${adchar.proLeader eq 'Y'}">리더</c:when>
							                <c:when test="${adchar.proLeader eq 'N'}">팀원</c:when>
							                <c:otherwise>상태 미정</c:otherwise>
							            </c:choose> 
						            </td>
								<c:choose>
								<c:when test="${adchar.proLeader eq 'N'}">
								<td>
								<div style="text-align: center;">
    										<input id="proSn" type="hidden" name="proSn" value="${adchar.proSn}" />  
    										<input class="empCdad" type="hidden" name="empCd" value="${adchar.emp.empCd }" />  
    										<a href="javascript:;" onclick="deleteFunction()" class="btn btn-danger">삭제</a> 
    										    
									</div>  
								</td> 
									</c:when>
								<c:when test="${adchar.proLeader eq 'Y'}">
								<td style="text-align: center;">	

									<button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#smallModalLeaderChange">
                         				리더변경 
                        			</button>
                        			</td> 
									</c:when>
								</c:choose> 
								</tr>	
								</c:forEach>
								
								
								
							
							
							  
												
							
					</c:if>
				</tbody>
				
				<tfoot>
					<tr>
						<td colspan="5">
							${paging.pagingHTML }
							<div id ="searchUI" class="row g-3 d-flex justify-content-center">
								<div class="col-auto">
									<form:select path = "simpleCondition.searchType" class="form-select"> 
										<form:option label="전체" value="" />
										<form:option label="이름" value="title" /> 
									</form:select>
								</div>
								<div class="col-auto">
								<form:input path="simpleCondition.searchWord" placeholder="검색키워드" class="form-control" />
								</div>
								<div class="col-auto">
								<input type="button" value="검색" id="searchBtn" class="btn btn-primary" />
								</div>
							</div>
						</td>
					</tr>
				</tfoot>
			</table>
		</div> 
	</div>
</div>








<!-- 모달창-->
<div class="modal fade" id="smallModalLeaderChange" tabindex="-1" 
	style="display: none;" aria-hidden="true">
	<div class="modal-dialog modal-sm" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel2">리더 변경</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"
					aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div> 
					<div class="col mb-0 wd100 mt-2">
						<label for="nameSmall" class="form-label">리더명</label>
						 <input 
							type="text" id="leaderName" class="form-control"
							placeholder="" readonly>  
					</div>
					<div class="col mb-0 wd100 mt-2">
						<label for="nameSmall" class="form-label">리더사번코드</label>
						 
						 <input 
							type="text" id="leaderNameCd" class="form-control" 
							placeholder="" readonly>  
					</div>
					<div class="col mb-0 wd100 mt-2">
            <label for="nameSmall" class="form-label">변경할 리더사원</label><br>
            <select id="changeLeader">
			    <option value="">선택해주세요.</option>
			    	<c:forEach items="${paging.dataList}" var="adchar">
			        	<option value="${adchar.emp.empCd}">
			            	${adchar.emp.empName} (${adchar.emp.empCd})
			     		</option>
				    </c:forEach> 
				</select> 
        </div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-label-secondary"
					data-bs-dismiss="modal">닫기</button>
				<button type="button" class="btn btn-primary">수정하기</button> 
			</div>
		</div>
	</div>
</div> 












<!-- 히든태그 사용 -->
<form:form modelAttribute="simpleCondition" method="get" id = "searchForm" class = "border" >
	<form:hidden path="searchType" readonly="readonly" placeholder="searchType"/>
	<form:hidden path="searchWord" readonly="readonly" placeholder="searchWord"/>
	<input type="hidden" name="page" readonly="readonly" placeholder="page"/>
</form:form>

<script>


$(document).on('click', '.btn-secondary', function() {
    var leaderNameCd = $(this).closest('tr').find('td:nth-child(2)').text().trim();
    var leaderName = $(this).closest('tr').find('td:nth-child(3)').text().trim();
 
    console.log('Leader Name:', leaderName);



    // 모달에 데이터 설정
    $('#leaderName').val(leaderName);
    $('#leaderNameCd').val(leaderNameCd);
}); 


function deleteFunction(event) {
    var empCd = event.target.parentElement.querySelector('input[name="empCd"]').value;
    var proSn = event.target.parentElement.querySelector('input[name="proSn"]').value;

    if (confirm("정말로 삭제하시겠습니까?")) {
        let pmemberVO = {
            empCd: empCd,
            proSn: proSn
        }

        console.log("pmemdel==={}", pmemberVO);

        $.ajax({
            type: "DELETE",
            url: "/adminproject/{proSn}",
            data: JSON.stringify(pmemberVO),
            contentType: 'application/json; charset=utf-8',
            dataType: "text",
            success: function (resp) {
                location.reload();
                alert("삭제 성공"); 
            },
            error: (xhr) => {
                console.log(xhr.status);
            }
        })
    } else {
        // 사용자가 취소를 선택한 경우
        return false;
    }
}
 
var deleteButtons = document.querySelectorAll('.btn.btn-danger');
deleteButtons.forEach(function (button) {
    button.addEventListener('click', deleteFunction);
});


	function fn_paging(page) {
		searchForm.page.value = page;
		searchForm.requestSubmit();
	}
	$(searchUI).on("click", "#searchBtn", function(event){
		let inputs = $(this).parents("#searchUI").find(":input[name]");
		$.each(inputs, function(idx, ipt){
			let name = ipt.name;
			let value = $(ipt).val();
			$(searchForm).find(`:input[name=\${name}]`).val(value);
			$(searchForm).submit();
		});
	}); 

</script>