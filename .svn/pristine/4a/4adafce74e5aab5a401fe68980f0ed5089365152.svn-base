<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.pms.job.dao.JobDAO">

<!--  [[개정이력(Modification Information)]]       -->
<!--  수정일        	수정자     수정내용               -->
<!--  ==========   		======    ==============        -->
<!--  2023. 11. 08.     김보영     최초작성               -->
<!--  2023. 11. 08.     김보영     참여자목록 , 일감상태카운팅   -->
<!--  2023. 11. 13.     김보영     일감목록               -->
<!--  2023. 11. 15.     김보영     일감등록,담당자등록               -->
<!--  Copyright (c) 2023 by DDIT All right reserved -->
	
	<resultMap type="ProjectVO" id="proInfo" autoMapping="true">
		<id property="proSn" column="PRO_SN"/>
		<association property="common" javaType="CommonVO"/>
		<collection property="pmemberList" ofType="PmemberVO" autoMapping="true">
			<id property="empCd" column="EMP_CD" />
			<id property="proSn" column="PRO_SN"/>
			<association property="emp" javaType="EmployeeVO" autoMapping="true">
				<association property="dept" javaType="DeptVO" autoMapping="true" />	
			</association>
		</collection> 
		<collection property="pjobList" ofType="PjobVO" autoMapping="true">
			<id property="jobSn" column="JOB_SN" />
			<id property="proSn" column="PRO_SN"/>
			<collection property="chargerList" ofType="ChargerVO"  autoMapping="true">
				<id property="proSn" column="PRO_SN"/>
				<id property="jobSn" column="JOB_SN" />
				<id property="empCd" column="EMP_CD" />
			</collection>
		</collection>
	</resultMap>
	
	
	<resultMap type="PjobVO" id="jobList" autoMapping="true">
		<id property="jobSn" column="JOB_SN" />
		<id property="proSn" column="PRO_SN"/>
		<collection property="chargerList" ofType="ChargerVO"  autoMapping="true">
			<id property="empCd" column="EMP_CD" />
			<association property="emp" javaType="EmployeeVO" autoMapping="true" />
		</collection>
	</resultMap>
	
	
	
	<resultMap type="PmemberVO" id="pMemberList" autoMapping="true">
		<id property="empCd" column="EMP_CD" />
		<id property="proSn" column="PRO_SN"/>
			<association property="emp" javaType="EmployeeVO" autoMapping="true">
				<association property="dept" javaType="DeptVO" autoMapping="true" />	
			</association>
	</resultMap>
	
	<!-- 일감상태 카운트 -->
	<select id="jobCount" resultType="PjobVO" parameterType="PjobVO">
		
		SELECT 
			SUM(DECODE(J.JOB_STCD, '1', CNT, 0)) AS AA_CNT
			,SUM(DECODE(J.JOB_STCD, '2', CNT, 0)) AS BB_CNT
			,SUM(DECODE(J.JOB_STCD, '3', CNT, 0)) AS CC_CNT
			,SUM(DECODE(J.JOB_STCD, '4', CNT, 0)) AS DD_CNT
			,SUM(DECODE(J.JOB_STCD, '5', CNT, 0)) AS EE_CNT
		FROM (
			SELECT 
				J.JOB_STCD
				, COUNT(*) AS CNT
			FROM PJOB J
			INNER JOIN CHARGER C
			ON J.JOB_SN = C.JOB_SN
			AND J.PRO_SN = C.PRO_SN
			WHERE J.PRO_SN = #{proSn}
			AND  C.EMP_CD = #{empCd1}
			GROUP BY J.JOB_STCD
		) J
		
	</select>
	
	
	<!-- 참여자리스트 -->
	<select id="proMemList" resultMap="pMemberList" parameterType="PmemberVO">
	
		SELECT 
			R.PRO_SN
			, R.PRO_NM
			, R.PRO_BDATE
			, R.PRO_EDATE
			, R.PRO_STTUS
			, R.PRO_PROGRS
			, P.EMP_CD
			, E.EMP_NAME
			, E.EMP_PROFILE_IMG
			, D.DEPT_NAME
			, P.PRO_LEADER
		FROM PROJECT R
			LEFT OUTER JOIN PMEMBER P
				ON R.PRO_SN = P.PRO_SN
			LEFT OUTER JOIN EMPLOYEE E
				ON P.EMP_CD = E.EMP_CD
			LEFT OUTER JOIN DEPT D
				ON D.DEPT_CD = E.DEPT_CD
		WHERE R.PRO_SN = #{proSn}
	
	</select>
	
	<!-- 일감의 담당자 -->
	<select id="chargerList" resultType="ChargerVO" parameterType="int">
		SELECT 
			E.EMP_NAME
			, C.JOB_SN
			, C.PRO_SN 
			, C.EMP_CD
		FROM EMPLOYEE E
		INNER JOIN CHARGER C
		ON C.EMP_CD = E.EMP_CD
		WHERE C.JOB_SN = #{jobSn}
	</select>
	
	<select id="UJobList" parameterType="String" resultType="PjobVO">
		SELECT 
			JOB_SJ
			, JOB_SN
		FROM PJOB
		WHERE PRO_SN = #{proSn,jdbcType=VARCHAR}
		AND JOBU_SN IS NULL
	</select>
	<sql id="searchFrag">
    	<if test="simpleCondition neq null and @org.apache.commons.lang3.StringUtils@isNotBlank(simpleCondition.searchWord)">
    		<choose>
    			<when test="simpleCondition.searchType eq 'title'">
    				AND INSTR(J.JOB_SJ, #{simpleCondition.searchWord}) > 0
    			</when>
    			<when test="simpleCondition.searchType eq 'charger'">
    				AND INSTR(GET_EMP_NAME(J.JOB_WRITER), #{simpleCondition.searchWord}) > 0
    			</when>
    			<otherwise>
    				AND
    				(
	   					INSTR(J.JOB_SJ, #{simpleCondition.searchWord}) > 0
	   					OR
	   					INSTR(GET_EMP_NAME(J.JOB_WRITER), #{simpleCondition.searchWord}) > 0
    				)
    			</otherwise>
    		</choose>
    	</if>
	</sql>
	
	<!-- 하나의 프로젝트에 해당하는 일감목록 -->
	<select id="selectPjobList" resultType="PjobVO" parameterType="PaginationInfo">
		SELECT B.*
		FROM(
			SELECT 
				ROWNUM rnum , A.*
			FROM(
				SELECT 
				    J.JOB_SN
				    , J.PRO_SN
				    , J.JOBU_SN
				    , J.JOB_SJ
				    , J.JOB_WRITER 
				    , GET_EMP_NAME(J.JOB_WRITER) AS findName
				    , J.JOB_RDATE
				    , J.JOB_STCD
				    , J.JOB_PRIORT
				    , J.JOB_BDATE
				    , J.JOB_EDATE
				    , J.JOB_CDATE
				    , J.JOB_CN
				    , J.PRO_FILE_CD
				    , J.JOB_PROGRS
				    , J.JOB_SCOPE
				    , C.EMP_PROFILE_IMGS
				FROM
					PJOB J
				INNER JOIN( 
					SELECT 
					    LISTAGG(NVL(E.EMP_PROFILE_IMG,'/resources/images/basic.png'), ', ') WITHIN GROUP (ORDER BY E.EMP_PROFILE_IMG) AS EMP_PROFILE_IMGS,
					    C.JOB_SN AS JOB_SN,
					    C.PRO_SN AS PRO_SN
					FROM EMPLOYEE E
					INNER JOIN CHARGER C ON C.EMP_CD = E.EMP_CD
					GROUP BY C.JOB_SN, C.PRO_SN
				) C
				ON J.JOB_SN = C.JOB_SN
				AND J.PRO_SN = C.PRO_SN
				WHERE  J.PRO_SN =  #{detailCondition.proSn}
		     	<include refid="searchFrag" />
				START WITH
					J.JOBU_SN IS NULL
				CONNECT BY PRIOR J.JOB_SN = J.JOBU_SN
				)A	
			)B
		WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<!-- 총 레코드수  -->
	<select id="selectTotalRecord" resultType="int" parameterType="PaginationInfo">
		SELECT 
			COUNT(*)
		FROM
			PJOB J
		INNER JOIN( 
			SELECT 
			    LISTAGG(NVL(E.EMP_PROFILE_IMG,'/resources/images/basic.png'), ', ') WITHIN GROUP (ORDER BY E.EMP_PROFILE_IMG) AS EMP_PROFILE_IMGS,
			    C.JOB_SN AS JOB_SN,
			    C.PRO_SN AS PRO_SN
			FROM EMPLOYEE E
			INNER JOIN CHARGER C ON C.EMP_CD = E.EMP_CD
			GROUP BY C.JOB_SN, C.PRO_SN
		) C
		ON J.JOB_SN = C.JOB_SN
		AND J.PRO_SN = C.PRO_SN
		WHERE  J.PRO_SN =  #{detailCondition.proSn}
     	<include refid="searchFrag" />
		START WITH
			J.JOBU_SN IS NULL
		CONNECT BY PRIOR J.JOB_SN = J.JOBU_SN
	</select>
	
	<!-- 일감의 작성자를 찾는 쿼리 -->
	<select id="selectWriter" resultType="EmployeeVO" parameterType="String">
		SELECT 
			EMP_NAME
		FROM EMPLOYEE
		WHERE EMP_CD =#{empCd}
	</select>
	
	<!-- 일감의 번호를 등록하기 위한 시퀀스-->
	<select id="selectJobSn" resultType="int">
		SELECT JOB_SEQ.NEXTVAL AS jobSn FROM DUAL
	</select>
	
	<!-- 일감등록 -->
	<insert id="insertJob" parameterType="PjobVO">
		<selectKey resultType="string" order="BEFORE" keyProperty="proFileCd">
			SELECT 
				#{proSn}|| TO_CHAR(PFILE_SEQ.NEXTVAL,'FM000') AS proFileCd 
			FROM DUAL
		</selectKey>
		INSERT INTO PJOB
		(
			JOB_SN
			, PRO_SN
			, JOBU_SN
			, JOB_SJ
			, JOB_WRITER
			, JOB_RDATE
			, JOB_STCD
			, JOB_PRIORT
			, JOB_BDATE
			, JOB_EDATE
			, JOB_CDATE
			, JOB_CN
			, PRO_FILE_CD
			, JOB_PROGRS
			, JOB_SCOPE
		)
		VALUES(
			#{jobSn,jdbcType=NUMERIC}
			, #{proSn,jdbcType=VARCHAR}
			, #{jobuSn,jdbcType=NUMERIC}
			, #{jobSj,jdbcType=VARCHAR}
			, #{jobWriter,jdbcType=VARCHAR}
			, sysdate	
			, #{jobStcd,jdbcType=VARCHAR}
			, #{jobPriort,jdbcType=NUMERIC}
			, #{jobBdate,jdbcType=VARCHAR}
			, #{jobEdate,jdbcType=VARCHAR}
			, #{jobCdate,jdbcType=VARCHAR}
			, #{jobCn,jdbcType=VARCHAR}
			, #{proFileCd,jdbcType=VARCHAR}
			, #{jobProgrs,jdbcType=NUMERIC}
			, 1	
		)
	</insert>
	
	<!-- 담당자등록 -->
	<insert id="insertCharger" parameterType="ChargerVO">
		INSERT INTO CHARGER
		(
			EMP_CD
			, JOB_SN
			, PRO_SN
		)
		VALUES
		(
			#{empCd}
			, #{jobSn}
			, #{proSn}
		)
	</insert>
	
	<!-- 일감삭제-->
	<delete id="deleteJob" parameterType="PjobVO">
		DELETE FROM PJOB
		WHERE JOB_SN=#{jobSn}
		AND JOB_WRITER=#{jobWriter}
		AND JOBU_SN IS NOT NULL
	</delete>
	
	<!-- 일감삭제시 해당 담당자도 삭제 -->
	<delete id="deleteCharger" parameterType="int">
		DELETE FROM CHARGER
		WHERE JOB_SN=#{jobSn} 
	</delete>
	
	
	<!-- 해당 프로젝트의 내 일감 조회 -->
	<select id="myJobList" resultMap="jobList"  parameterType="ChargerVO">
		SELECT	
			C.EMP_CD
			, C.JOB_SN
			, C.PRO_SN
			, J.JOB_SJ
			, J.JOB_PRIORT
			, J.JOB_PROGRS
			, J.JOB_EDATE
			, J.JOB_STCD
		FROM PJOB J 
		LEFT OUTER JOIN CHARGER C	
		ON J.JOB_SN = C.JOB_SN
		AND J.PRO_SN = C.PRO_SN
		WHERE C.EMP_CD = #{empCd,jdbcType=VARCHAR} 
		AND C.PRO_SN =#{proSn,jdbcType=VARCHAR} 
		ORDER BY J.JOB_PRIORT ASC, J.JOB_EDATE ASC 
	</select>
	
	<!-- 일감 상세조회 -->
	<select id="jobDetail" resultMap="jobList" parameterType="int">
		SELECT	
			C.EMP_CD
			, GET_EMP_NAME(C.EMP_CD) AS findName2 
			, C.PRO_SN
			, J.JOB_SN
		    , J.JOBU_SN
		    , J.JOB_SJ
		    , J.JOB_WRITER 
		    , GET_EMP_NAME(J.JOB_WRITER) AS findName
		    , J.JOB_RDATE
		    , J.JOB_STCD
		    , J.JOB_PRIORT
		    , J.JOB_BDATE
		    , J.JOB_EDATE
		    , J.JOB_CDATE
		    , J.JOB_CN
		    , J.PRO_FILE_CD
		    , J.JOB_PROGRS
		    , J.JOB_SCOPE
		FROM PJOB J 
		RIGHT OUTER JOIN CHARGER C	
		ON C.JOB_SN = J.JOB_SN
		AND C.PRO_SN = J.PRO_SN
		WHERE J.JOB_SN = #{jobSn}
	</select>
	
</mapper>