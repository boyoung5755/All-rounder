<%--
* [[개정이력(Modification Information)]]
* 수정일          수정자      수정내용
* ----------  ---------  -----------------
* 2023. 11. 22. 전수진      최초작성
* Copyright (c) 2023 by DDIT All right reserved
 --%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>    
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="sec" %>
<script src="${pageContext.request.contextPath }/resources/js/ckeditor/ckeditor.js"></script>


<style>
	.card-header {
		text-align: center;
		font-weight: 800;
		background-color: #fff;
	}
	.first {
		height: 450px;
	}
	.second {
		height: 200px;
	}
	table {
	    border-collapse: collapse;
	    height: 30px;
	    width: 100%;
	}
	td {
	    border-color: black;
	    border-style: solid;
	    border-width: 1px;
	    height: 30px;
	}
	.title-cell {
	    background-color: #e2e2e2;
	    text-align: center;
	    width: 15%;
	}
	
	strong span {
	    font-size: 11px;
	}
	.error {
	    color: red;
	}
		
</style>


결재문서 Detail
<div class="content-wrapper">
<!-- Content -->
	<div class="container-xxl flex-grow-1 container-p-y">
	<%-- 로그인한 사람에 따라 버튼에 대한 처리 다르게 --%>	
	<sec:authorize access="isAuthenticated()">
		<sec:authentication property="principal" var="principal"/>
		<c:set var="loginCd" value="${principal.realUser.empCd }" />
		<c:set var="drafterCd" value="${sanction.drafter }" />
			<c:if test="${loginCd eq drafterCd }">
				<button class="btn btn-sm btn-outline-primary" onclick="modifyFunction()" id="editBtn">수정</button> <button class="btn btn-sm btn-outline-primary" onclick="deleteFunction()" id="deleteBtn">삭제</button>
			</c:if>
			<c:forEach var="sanctnerCd" items="${sanction.lineList }">
				<c:if test="${loginCd eq sanctnerCd.sanctner }">
					<button class="btn btn-sm btn-outline-primary" id="approvalBtn">승인</button> <button class="btn btn-sm btn-outline-primary" id="rejectedBtn">반려</button> 
				</c:if>
			</c:forEach>
			<button class="btn btn-sm btn-outline-secondary" onclick="location.href = '/sanction'" id="listBtn">목록</button>
	</sec:authorize>		
		<div class="row">
		<!-- User Content -->
			<div class="col-xl-8 col-lg-7 col-md-7 order-1 order-md-0">
				<div class="card mb-4">
					<div class="card-body">
					<%-- 여기에 승인했을때 결재선테이블 출력예정 --%>
<%-- 					<img src="${sanctionLineVO.signImg}" /> --%>
					
					
						<h2 class="card-header">${sanction.sanctionForm.formNm }</h2>
							<div class="table-responsive mb-3">
								<table>
									<tbody>
										<tr>
											<td class="title-cell">
												<strong><span>제목</span></strong>
											</td>
											<td>
												${sanction.sanctnSj }
											</td>
										</tr>
										<tr>
											<td class="title-cell">
												<strong><span>작성일자</span></strong>
											</td>
											<td>
												${sanction.sanctnDate }
											</td>
										</tr>
										<tr>
											<td class="title-cell">
												<strong><span>작성부서</span></strong>
											</td>
											<td>
												${sanction.drafterDeptName }
											</td>
										</tr>
										<tr>
											<td class="title-cell">
												<strong><span>작성자</span></strong>
											</td>
											<td>
												${sanction.drafterNm }
											</td>
										</tr>
										<tr>
											<td class="title-cell">
												<strong><span>수신자</span></strong>
											</td>
											<td>
											[${sanction.sanctnRcyerDeptName }] ${sanction.sanctnRcyerNm } ${sanction.sanctnRcyerRankNm }
											</td>
										</tr>
									</tbody>
								</table>
								<br />
								<div class="mb-3">
									${sanction.sanctnSourc }
								</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-xl-4 col-lg-5 col-md-5 order-0 order-md-1">
				<div class="card mb-4">
					<div class="card-body first">
						<div class="d-flex justify-content-center pt-3">
						</div>
						<h5 class="pb-2 border-bottom mb-4">결재선</h5>
						<p>[${sanction.drafterDeptName }] ${sanction.drafterNm } ${sanction.drafterRankNm } <span class="badge rounded-pill bg-label-info">기안</span></p>
						<form>
							<div class="info-container" id="sanctionLine">
								<!-- 
								sanction.lineList : List<SanctionLineVO>
								 -->
								<c:if test="${not empty sanction.lineList}">
									<c:forEach var="sanctionLineVO" items="${sanction.lineList}">
								        <p>[${sanctionLineVO.sanctnerDeptName}] ${sanctionLineVO.sanctnerNm} ${sanctionLineVO.sanctnerRankNm} 
										<c:choose>
												<c:when test="${sanctionLineVO.sanctnlineSttus eq 'I'}">
													<span class="badge rounded-pill bg-label-secondary">미결</span>
												</c:when>
												<c:when test="${sanctionLineVO.sanctnlineSttus eq 'C'}">
													<span class="badge rounded-pill bg-label-info">승인</span>
												</c:when>
												<c:when test="${sanctionLineVO.sanctnlineSttus eq 'P'}">
													<span class="badge rounded-pill bg-label-info">대결</span>
												</c:when>
												<c:when test="${sanctionLineVO.sanctnlineSttus eq 'R'}">
													<span class="badge rounded-pill bg-label-danger">반려</span>
												</c:when>
										</c:choose>
											<br/>
											${sanctionLineVO.sanctnOpinion}
										</p>
									</c:forEach>
								</c:if>
							</div>
						</form> 
					</div>
				</div>
				<div class="card mb-4">
					<div class="card-body second">
						<div class="d-flex justify-content-center pt-3">
						</div>
						<h5 class="pb-2 border-bottom mb-4">첨부파일</h5>
						<div class="info-container" id="fileList">
							<c:if test="${not empty sanction.attachList }">
								<c:forEach items="${sanction.attachList }" var="attach">
									<p class="mb-4">
									<c:url value="/sanction/${sanction.sanctnNo }/sanctionAttach/${attach.attachNo }" var="downloadUrl" />
									<a href="${downloadUrl }" title="${attach.attachFancysize }">${attach.attachOriginNm }
									</a>
									</p>	
								</c:forEach>
							</c:if>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<script>
 	function modifyFunction(){
 		var sttus = ${sanction.sanctnSttus};
 		
 		if(sttus=="0" || sttus=="1") {
	 		console.log("요거?",sttus);
 			alert("수정가능");
 			location.href=`/sanction/${sanction.sanctnNo}/edit`;
 		} else {
	 		alert("결재가 진행중 입니다! 삭제 불가!");
 		} 
 	}

	function deleteFunction(){
		if(confirm("정말로 삭제하시겠습니까?")){
			$.ajax({
				method : "delete",
				url : `/sanction/${sanctnNo}`,
				success:function(resp){
					console.log("서버에서 돌아온 값",resp);
					if (resp.msg == "OK") {
						alert("결재문서가 삭제되었습니다!");
						location.href=`/sanction`;
					} else if (resp.msg == "CANNOTPROCEED"){ 
						alert("결재가 진행중 입니다! 삭제 불가!");
					} else {
						alert("결재문서가 삭제에 실패하였습니다!");
					}
				},
				error: (xhr) => {
					console.log(xhr.status);
				}
			});
		}
	}
</script>