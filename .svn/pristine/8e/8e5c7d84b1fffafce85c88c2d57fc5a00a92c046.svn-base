<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>    
<%@ taglib uri="http://www.springframework.org/tags/form" prefix="form" %>    
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring" %>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>
<%
  String contextPath = request.getContextPath();
%>
<div class="webRoute" style="display:flex;" data-web-user="${cours}"></div>
<div class="card" id="webBody" style="width:100%; height:90%;">
<div class="card-body" id="listBody" style="display:flex; flex-wrap: wrap;">
<%-- <c:forEach items="${webList}" var="web"> --%>
<!-- 	<tr> -->
<%-- 	<c:if test="${empty web.webTy}"> --%>
<%-- 		<td><a href="<c:url value='/web?webCours=${web.webCours}${web.webSnm}/'/>">폴더 : ${web.webRnm}</a></td> --%>
<%-- 	</c:if> --%>
<%-- 	<c:if test="${not empty web.webTy}"> --%>
<%-- 		<td>파일 : ${web.webRnm}</td> --%>
<%-- 	</c:if> --%>
<!-- 	</tr> -->
<%-- 	</c:forEach> --%>
</div>
</div>
<script>

$(function(){
// 	console.log(csrfparam);
// 	console.log(csrf);
	ajaxList(cours);
});
let csrfparam = $("meta[name='_csrf_parameter']").attr("content");
let csrf = $("meta[name='_csrf']").attr("content");
let webHardUser=document.querySelector(".webRoute").getAttribute('data-web-user');

// var contextPath='\${pageContext.request.contextPath}';
var cours="/";
var beforeCours="";
var rnm="내 드라이브";

var ajaxList=function(cours){
	let uri="/web/list?webCours="+cours+"&who="+webHardUser;
	let xhr=new XMLHttpRequest();
    xhr.open("get",uri,true);
    xhr.onreadystatechange=()=>{
        if(xhr.readyState==4&&xhr.status==200){
        	let datas = JSON.parse(xhr.responseText) 
        	let target = datas.webList;
//         	console.log(target);
        	makeList(target);
        }
    }
    xhr.send();
}

let div=``;
let webRoute = document.querySelector(".webRoute");

var makeList = function(webList){
// 	$("<div>").addClass("back")
// 	=
// 	let newDiv= document.createElement("div");
// 	newDiv.classList.add("back");
	let newDiv= document.createElement("h4");
	newDiv.setAttribute("data-value", cours);
	newDiv.setAttribute("data-name", rnm);
	newDiv.style.marginRight = "5px";
	newDiv.textContent =rnm;
	newDiv.addEventListener("click",function(){
		cours=this.getAttribute("data-value");
		deleteCours = webRoute.querySelectorAll(`[data-value*="\${cours}"]`);
		for(let i=0;i<deleteCours.length;i++){
			let ab=cours.length;
			let abc=deleteCours[i].getAttribute("data-value").length;
			if(ab<=abc){
// 				console.log("삭제 : ",deleteCours[i]);
				if(cours!==beforeCours){
					rnm=this.getAttribute("data-name");
					webRoute.removeChild(deleteCours[i]);
				}
			}
		}
// 		deleteCours.forEach(function(deleteCour){
// 			let ab=cours.length;
// 			let abc=deleteCour.length;
// 			if(ab<abc){
// 				webRoute.removeChild(deleteCour);
// 			}
// 		});
		ajaxList(cours);
	});
	if(cours!==beforeCours){
		webRoute.appendChild(newDiv);
	}
	beforeCours=cours;
// 	div+=`<div class="back" data-value="\${cours}">\${rnm}</div>`;
	let list=``;
	for(let i=0;i<webList.length;i++){
		list+=`<div class="webFileMenu" style="width:100px; height:130px; text-align:center; margin: 0 1.5%;">`;
		if(!webList[i].webTy){	/* 폴더일 때 */
			list+=
				`<div class="webFolder" data-serial="\${webList[i].webSnm}" data-name="\${webList[i].webRnm}" data-value="\${cours}\${webList[i].webSnm}/">
					<img style="width:100px; height:100px;" src="<%= contextPath %>/resources/images/webHard/webFolder.png"/>\${webList[i].webRnm}
				</div>`;
		}else{	/* 파일일 때 */
			list+=
				`<div class="webFile" data-ty="\${webList[i].webTy}" data-serial="\${webList[i].webSnm}" data-local="\${webList[i].webRnm}" data-value="\${cours}\${webList[i].webSnm}.\${webList[i].webTy}">
					<img style="width:100px; height:100px;" src="<%= contextPath %>/resources/images/webHard/\${webList[i].webTy}.png"/>\${webList[i].webRnm}
				</div>`;
		}
		list+=`</div>`;
	}
// 	console.log("list", list)
// 	let listBody = document.querySelector("#listBody");
	listBody.innerHTML=list;
	
// 	console.log("listBody", document.querySelector("#listBody"))
	var folder=document.querySelectorAll(".webFolder");
	
	for(let i=0; i<folder.length; i++){
		folder[i].addEventListener("dblclick", function(){
	 		cours=this.getAttribute("data-value");
	 		rnm="/       " + this.getAttribute("data-name");
	 		ajaxList(cours);
		});
	}
	
	let webFileMenu=document.querySelectorAll(".webFileMenu");
	
	for(let i=0;i<webFileMenu.length;i++){
		let webFileMenus=webFileMenu[i];
		//var webMenuDiv = document.createElement('div');
		webFileMenus.addEventListener("contextmenu", function(e){
			e.preventDefault();
			
			var target=e.target;
			var webParentNode = null;
			
			while(webParentNode==null){
				if(target.tagName.toLowerCase()==='div'){
					webParentNode=target;
					break;
				}
				target=target.parentNode;
			}
			let dataSerial=webParentNode.getAttribute('data-serial');
			
			webFileMenusRemove(e.target);
			
		    // 메뉴를 담을 div 요소 생성
		    /* if(!webMenuDiv.contains(e.target) && webMenuDiv){
		    	console.log(webMenuDiv);
		    	document.body.removeChild(webMenuDiv);
		    } */
		    var webMenuDiv = document.createElement('div');
		    webMenuDiv.classList.add('webFileMenus');
			
		    console.log(webParentNode.classList[0]);
		    if(webParentNode.classList[0]!=='webFolder'){
		    	// 메뉴 아이템들 생성
			    var webDownload = document.createElement('div');
			    webDownload.textContent = '다운로드';
			    webDownload.style.borderBottom = '1px solid #ccc';
			    webDownload.style.margin = '5px'; // 아이템 간격을 줄 바꿈으로 대체
			    webDownload.addEventListener('click', function(e) {
			    	let dataValue=webParentNode.getAttribute('data-value');
			    	let dataLocal=webParentNode.getAttribute('data-local');
			        
			        let formData = new FormData();
			    	formData.append("ftpFile",dataValue);
			    	formData.append("localFile",dataLocal);
			    	
			    	fileDown(formData);
			    });
			    
			    webMenuDiv.appendChild(webDownload);
		    }

		    var webDelete = document.createElement('div');
		    webDelete.textContent = '삭제';
		    webDelete.style.borderBottom = '1px solid #ccc';
		    webDelete.style.margin = '5px'; // 아이템 간격을 줄 바꿈으로 대체
		    webDelete.addEventListener('click', function() {
		    	let dataSerial=webParentNode.getAttribute('data-serial');
		    	
		    	webFileDel(dataSerial);
		    });

		    var webUpdName = document.createElement('div');
		    webUpdName.textContent = '이름 변경';
		    webUpdName.style.margin = '5px'; // 아이템 간격을 줄 바꿈으로 대체
		    webUpdName.addEventListener('click', function() {
		    	let udpName=window.prompt("변경할 이름을 입력해주세요.", "이름");
		    	let dataSerial=webParentNode.getAttribute('data-serial');
		    	let dataTy=webParentNode.getAttribute('data-ty');
		    	if(dataTy){
		    		udpName+='.'+dataTy;
		    	}

		    	let data={
		    		webSnm:dataSerial,
		    		webRnm:udpName,
		    		webCours:cours
		    	}
		    	webUdpName(data);
		    });

		    // 메뉴 아이템들을 메뉴에 추가
		    webMenuDiv.appendChild(webDelete);
		    webMenuDiv.appendChild(webUpdName);

		    // 스타일 설정 - 위치 설정
		    webMenuDiv.style.position = 'absolute';
		    webMenuDiv.style.left = event.clientX + 'px'; // 마우스 클릭 위치 X 좌표
		    webMenuDiv.style.top = event.clientY + 'px'; // 마우스 클릭 위치 Y 좌표
		    webMenuDiv.style.background = '#fff';
		    webMenuDiv.style.padding = '5px';
		    webMenuDiv.style.zIndex = '500'; // 다른 요소 위에 나타나도록 설정

		    // 생성된 div를 body에 추가
		    document.body.appendChild(webMenuDiv);
		    
		    // document에 클릭 이벤트 추가하여 메뉴를 닫음
		    document.addEventListener('click', function(e) {
		       	//if (!webMenuDiv.contains(e.target)) {
					webFileMenusRemove(e.target);
		       	//}
		    });
		    
		    document.addEventListener('contextmenu', function(e) {
		       	//if (!webMenuDiv.contains(e.target)) {
		       		webFileMenusRemove(e.target);
		        //}
		    });
		    
			// 겹쳐지는 이벤트(우클릭) 발생 막기
			event.stopPropagation();
		});
	}
}

function fileUpload(file){
	let formData = new FormData();
	/*
	console.log(formData);
    let web = {
    	file:document.getElementById("file").files[0],
    	webRnm:document.getElementById("webRnm").value,
   		webCours:cours
    };
    console.log(web);
    */
// 	let webRnm=document.getElementById("webRnm");
// 	let file=document.getElementById("file");
// 	let webCours=cours;
	
	//console.log("cours", cours);
	if(file){
		formData.append("file",file);
	}
	//formData.append("webRnm",document.querySelector("#webRnm").value);
	formData.append("webCours",cours);
	formData.append("who",webHardUser);

	let xhr=new XMLHttpRequest();
    xhr.open("post","/web",true);
    //xhr.setRequestHeader("Content-Type","application/json");
    xhr.setRequestHeader("${_csrf.headerName}",csrf);
    xhr.onreadystatechange=()=>{
        if(xhr.readyState==4 && xhr.status==200){
        	console.log("성공");
        	ajaxList(cours);
        }
    }
    xhr.send(formData);
}
	
function fileDown(form){
	
	let formData = form;
	
	let xhr=new XMLHttpRequest();
    xhr.open("post","/web/download",true);
//     xhr.setRequestHeader("Content-Type","application/json");
    xhr.setRequestHeader("${_csrf.headerName}",csrf);
    xhr.onreadystatechange=()=>{
        if(xhr.readyState==4 && xhr.status==200){
        	console.log("다운로드");
        }
    }
    xhr.send(formData);
}
	
function webFileDel(dataSerial){
	let formData = new FormData();
	
	formData.append("webSnm",dataSerial);
	formData.append("webCours",cours);

	let xhr=new XMLHttpRequest();
    xhr.open("post","/web/delete",true);
//     xhr.setRequestHeader("Content-Type","application/json");
    xhr.setRequestHeader("${_csrf.headerName}",csrf);
    xhr.onreadystatechange=()=>{
        if(xhr.readyState==4 && xhr.status==200){
        	ajaxList(cours);
        }
    }
    xhr.send(formData);
}
	
function webUdpName(data){
	let xhr=new XMLHttpRequest();
    xhr.open("post","/web/update",true);
    xhr.setRequestHeader("Content-Type","application/json");
    xhr.setRequestHeader("${_csrf.headerName}",csrf);
    xhr.onreadystatechange=()=>{
        if(xhr.readyState==4 && xhr.status==200){
        	ajaxList(cours);
        }
    }
    xhr.send(JSON.stringify(data));
}

// var second=function(){
// // 	console.log("여기 있다.")
// 	var back=document.querySelectorAll(".back");
// 	console.log(back);
// 	for(let i=0; i<back.length; i++){
// 		back[i].addEventListener("click",function(){
// 			console.log(this);
// 			cours=this.getAttribute("data-value");
// 			console.log("corus : ",cours);
// 			ajaxList(cours);
// 		});
// 	}
// }
// $(document).on("click",".back",function(){
// 	console.log(this);
// 	cours=this.getAttribute("data-value");
// 	console.log("corus : ",cours);
// 	ajaxList(cours);
// });
// 	folder.addEventListner('click',function(){
// 		cours=folder.getAttribute("data-value");
// 		console.log(cours);
// 	});
// }

ajaxList(cours);

// 마우스 우클릭 이벤트
// is_right_click=(event.which==3) || (event.button==2)

// const mouse_end = async(event) => {
//     if(is_right_click) return;
//     console.log("오른 클릭");
// }

// element.addEventListener("mouseup",mouse_end);

// window.oncontextmenu=function(){
//     return false;
// }

function makeFolder(folderName){
	let formData = new FormData();
	formData.append("webRnm",folderName);
	formData.append("webCours",cours);
	formData.append("who",webHardUser);

	let xhr=new XMLHttpRequest();
    xhr.open("post","/web",true);
    //xhr.setRequestHeader("Content-Type","application/json");
    xhr.setRequestHeader("${_csrf.headerName}",csrf);
    xhr.onreadystatechange=()=>{
        if(xhr.readyState==4 && xhr.status==200){
        	console.log("성공");
        	ajaxList(cours);
        }
    }
    xhr.send(formData);
}

//let listBody=document.getElementById('listBody');

// document에 클릭 이벤트 추가하여 메뉴를 닫음
webBody.addEventListener('contextmenu', function(e) {
	e.preventDefault();
	e.stopPropagation();
	webFileMenusRemove(e.target);
	
    // 메뉴를 담을 div 요소 생성
    var webMenuDiv = document.createElement('div');
    webMenuDiv.classList.add('webFileMenus');

    // 메뉴 아이템들 생성
    var newFolder = document.createElement('div');
    newFolder.textContent = '새 폴더';
    newFolder.style.borderBottom = '1px solid #ccc';
    newFolder.style.margin = '5px'; // 아이템 간격을 줄 바꿈으로 대체
    newFolder.addEventListener('click', function() {
        // 여기에 추가 기능을 구현할 수 있습니다.
        //console.log('추가 기능 실행');
        
        let folderName=window.prompt("폴더 이름을 입력해주세요.", "폴더 이름");
        if(folderName){
    		makeFolder(folderName);
        }else{
        	alert("이름을 입력해주세요.")
        }
    });

    var uploadItem = document.createElement('div');
    uploadItem.textContent = '파일 업로드';
    uploadItem.style.margin = '5px'; // 아이템 간격을 줄 바꿈으로 대체
    uploadItem.addEventListener('click', function() {
		var inputElement = document.createElement('input');
        inputElement.type = 'file';
        inputElement.style.display="none";
        
        inputElement.addEventListener('change', function(event) {
            var selectedFile = event.target.files[0]; // 선택된 파일 가져오기
            if (selectedFile) {
            	fileUpload(selectedFile);
                // 필요한 파일 정보를 이용하여 원하는 작업 수행
            } else {
                console.log('선택된 파일이 no에요');
            }
        });
        
        webBody.appendChild(inputElement);
        inputElement.click();
    });

    // 메뉴 아이템들을 메뉴에 추가
    webMenuDiv.appendChild(newFolder);
    webMenuDiv.appendChild(uploadItem);

    // 스타일 설정 - 위치 설정
    webMenuDiv.style.position = 'absolute';
    webMenuDiv.style.left = event.clientX + 'px'; // 마우스 클릭 위치 X 좌표
    webMenuDiv.style.top = event.clientY + 'px'; // 마우스 클릭 위치 Y 좌표
    webMenuDiv.classList.add('card-body');
    webMenuDiv.style.background = '#fff';
    webMenuDiv.style.padding = '5px';
    webMenuDiv.style.zIndex = '1000'; // 다른 요소 위에 나타나도록 설정

    // 생성된 div를 body에 추가
    document.body.appendChild(webMenuDiv);
    
    // document에 클릭 이벤트 추가하여 메뉴를 닫음
    document.addEventListener('click', function(e) {
		if (webMenuDiv.contains(e.target)) {
			webFileMenusRemove(e.target);
	    }
    });
    
    document.addEventListener('contextmenu', function(e) {
       	if (!webMenuDiv.contains(e.target)) {
       		webFileMenusRemove(e.target);
        }
    });
});

function webFileMenusRemove(e){
	let webFileMenusCheck=document.querySelectorAll(".webFileMenus");
// 	console.log("여기",e);
// 	console.log("여기",webFileMenusCheck);
	if(webFileMenusCheck?.length >0){
		for(let i=0;i<webFileMenusCheck.length;i++){
//			if(!webFileMenusCheck[i].contains(e)){
// 				debugger;
// 				console.log("삭제돼!!!!!!!!!!!!!!!!!!!!!!!!",e);
				webFileMenusCheck[i].remove();
//			}
		}
	}
}
</script>













