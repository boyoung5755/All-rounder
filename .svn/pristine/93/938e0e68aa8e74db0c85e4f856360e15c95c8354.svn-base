<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://www.springframework.org/tags" prefix="spring"%>
<%@ taglib uri="http://tiles.apache.org/tags-tiles" prefix="tiles"%>
<%@ taglib uri="http://www.springframework.org/security/tags" prefix="security" %>
<%@ taglib uri="http://www.springframework.org/tags/form"  prefix="form"%>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<%--
* [[개정이력(Modification Information)]]
* 수정일                 수정자      수정내용
* ----------  ---------  -----------------
* Nov 21, 2023      송석원      최초작성
* Copyright (c) 2023 by DDIT All right reserved
 --%> 
 
 <style>
 	.table:not(.table-dark) th {
    color: #566a7f;
    font-size: 17px;
    }
    .offcanvas, .offcanvas-xxl, .offcanvas-xl, .offcanvas-lg, .offcanvas-md, .offcanvas-sm {
    --bs-offcanvas-width: 900px;
    }
    .test{
    	border: 1px solid black;
    }
 </style>
 
<div class="card">
	<div class="card-header border-bottom">
		<h4 class="card-title">프로젝트 관리</h4>
		<div class="d-flex justify-content-between align-items-center row py-3 gap-3 gap-md-0">
			<div class="col-md-4 user_role"></div>
			<div class="col-md-4 user_plan"></div>
			<div class="col-md-4 user_status"></div> 
		</div>
	
		
		<div class="col-lg-3 col-md-6">
                      <div class="mt-3">
                        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasEnd" aria-controls="offcanvasEnd">
                          <span>
						<i class="bx bx-plus me-0 me-sm-1"></i>
						<span class="d-none d-sm-inline-block">생성</span>
					</span>
                        </button>
                        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasEnd" aria-labelledby="offcanvasEndLabel">
                          <div class="offcanvas-header">
                            <h5 id="offcanvasEndLabel" class="offcanvas-title">프로젝트 생성</h5>
                            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                          </div>
                          <div class="offcanvas-body  mx-0 flex-grow-0">
                          
     
		<form  id="byForm" action="/adminproject" method="POST" > 
			<div class="modal-body">
				<div class="row">
					<div class="col mb-3 test">
						제1영역
						<div id="orgTreeContainer"></div>
						사원, 부서 검색영역
					</div>
					<div class="col mb-0 test">제2영역
						<button type="button" id="remove">비우기</button>
						<br />
						 프로젝트명 <br />
						<input type="text" id="proNm" name="proNm"/><br>  
						프로젝트 시작일<br>
						  <input type="date" id="proBdate" name="proBdate" value="" required><br>
						  프로젝트 종료일 <br> 
						  <input type="date" id="proEdate" name="proEdate" value="" required><br> <br>
						<h5>참여자 명단</h5>
						<hr>
						<div id="orgTreeResult"></div>
					</div>
				</div>
			</div>  
			                  
                            <button type="submit" class="btn btn-primary mb-2 d-grid w-100"  id="pbtn4">프로젝트 생성</button> 
						 <security:csrfInput/>
						</form>
						
                            <button type="button" class="btn btn-label-secondary d-grid w-100" data-bs-dismiss="offcanvas">
                              Cancel
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
		<br />
	
		<div class="card-datatable table-responsive">
			<table class="table">
				<thead class="table-light">
					<tr>
						<th>상태</th> 
						<th style="text-align:center">프로젝트명</th> 
						<th>리더명</th>
						<th>팀원수</th>
						<th>상위일감수</th>
						<th>하위일감수</th>
						<th>프로젝트 기간</th> 
					</tr>
				</thead>
				<tbody class="table-border-bottom-0">
					<c:if test="${empty paging.dataList }">
						<tr> 
							<td colspan="6">검색 조건에 맞는 게시글 없음 </td>
						</tr>
					</c:if>
					<c:if test="${not empty paging.dataList }">
						<c:forEach	items="${paging.dataList }" var="adproj">
							<tr>
								<td>
						            <c:choose>
						                <c:when test="${adproj.proSttus eq 1}">진행</c:when>
						                <c:when test="${adproj.proSttus eq 2}">보류</c:when>
						                <c:when test="${adproj.proSttus eq 3}">완료</c:when>
						                <c:otherwise>상태 미정</c:otherwise>
						            </c:choose>
						        </td>
								<td style="text-align:center"> 
 									<a href="<c:url value='/adminproject/${adproj.proSn}'/>"> 
 						                ${adproj.proNm} 
						            </a>  
							</td>				
								<c:forEach	items="${adproj.pjobList}" var="pjoblt">
								
								<c:forEach	items="${pjoblt.chargerList}" var="projld">
								<c:forEach	items="${adproj.pmemberList}" var="pmemc">
									<td>	${projld.empCd}</td>
									
									<td>${pmemc.pmemCount }</td>
									
									<td>${pjoblt.upperJobcount }</td>
									<td>${pjoblt.lowerJobcount }</td>
								</c:forEach>
								</c:forEach>
								</c:forEach>				
								<td>${adproj.proBdate } ~ ${adproj.proEdate}</td>				
							</tr>
						</c:forEach>
					</c:if>
				</tbody>
				<tfoot>
					<tr>
						<td colspan="5">
							${paging.pagingHTML }
							<div id ="searchUI" class="row g-3 d-flex justify-content-center">
								<div class="col-auto">
									<form:select path = "simpleCondition.searchType" class="form-select"> 
										<form:option label="전체" value="" />
										<form:option label="제목" value="title" />
									</form:select>
								</div>
								<div class="col-auto">
								<form:input path="simpleCondition.searchWord" placeholder="검색키워드" class="form-control" />
								</div>
								<div class="col-auto">
								<input type="button" value="검색" id="searchBtn" class="btn btn-primary" />
								</div>
							</div>
						</td>
					</tr>
				</tfoot>
			</table>
		</div> 
	</div>
</div>
<!-- 히든태그 사용 -->
<form:form modelAttribute="simpleCondition" method="get" id = "searchForm" class = "border" >
	<form:hidden path="searchType" readonly="readonly" placeholder="searchType"/>
	<form:hidden path="searchWord" readonly="readonly" placeholder="searchWord"/>
	<input type="hidden" name="page" readonly="readonly" placeholder="page"/>
</form:form>

<script>
	const byForm = document.querySelector("#byForm");

	byForm.addEventListener("submit",()=>{
		event.preventDefault();

		 const pmemberList = [];
		 const pMems = byForm.querySelectorAll("[name=pMember]");
		 console.log("체킁:",pMems);

		 for(let i=0; i< pMems.length; i++){
			let pMemVO = {
				empCd: pMems[i].value
			}
			pmemberList.push(pMemVO);
		 }

		// 개발모드에서는 항상 필요한 데이타가 보이도록 프로그램
		let projVO = {
		 	proNm:byForm.proNm.value,	
 			proBdate:byForm.proBdate.value,		
 			proEdate:byForm.proEdate.value,	
			pmemberList:pmemberList
		}
        
		console.log("projVO",projVO);

		$.ajax({
			type:"post",
			url:"/adminproject",
			contentType:"application/json",
			data: JSON.stringify(projVO),
			dataType:"text",
			success:function(resp){
				console.log("체크:",resp);
				location.reload();
			},
			error:function(xhr){
				console.log("Error:",xhr.status);
			}
		})


	})



	function fn_paging(page) {
		searchForm.page.value = page;
		searchForm.requestSubmit();
	}
	$(searchUI).on("click", "#searchBtn", function(event){
		let inputs = $(this).parents("#searchUI").find(":input[name]");
		$.each(inputs, function(idx, ipt){
			let name = ipt.name;
			let value = $(ipt).val();
			$(searchForm).find(`:input[name=\${name}]`).val(value);
			$(searchForm).submit();
		});
	});

</script>
<script src="${pageContext.request.contextPath }/resources/js/app/adproject/addproject.js"></script> 